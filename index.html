<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸ªäºº Dashboard Â· è´¢åŠ¡ & å­¦ä¹ æ—¶é—´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f3f4f6; font-family: 'Segoe UI', Roboto, sans-serif; }
    .card { transition: all 0.3s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <!-- é¡¶éƒ¨ï¼šæ ‡é¢˜ + å…¨å±€è¯­è¨€åˆ‡æ¢ + Tab -->
    <header class="mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <!-- å·¦ï¼šæ ‡é¢˜ -->
      <div class="space-y-1">
        <h1 class="text-xl md:text-2xl font-semibold text-gray-900 flex items-center gap-2">
          <span class="inline-block w-2 h-2 rounded-full bg-sky-400 shadow"></span>
          <span>Dustin ä¸ªäºº Dashboard</span>
        </h1>
        <p class="text-xs md:text-sm text-gray-500">
          ç®¡ç†æ—¥å¸¸å¼€é”€å’Œå­¦ä¹ æ—¶é—´ï¼Œé•¿æœŸè·Ÿè¸ªç°é‡‘æµ / Python / ç»æµå­¦ / é›…æ€å­¦ä¹ è¿›åº¦ã€‚
        </p>
      </div>

      <!-- å³ï¼šè¯­è¨€åˆ‡æ¢ + Tab -->
      <div class="flex flex-col items-stretch md:items-end gap-2">
        <!-- å…¨å±€è¯­è¨€åˆ‡æ¢ï¼ˆè´¢åŠ¡ + å­¦ä¹  å…±ç”¨ï¼‰ -->
        <div class="flex items-center justify-end gap-2">
          <span class="hidden md:inline text-[11px] text-gray-400">ç•Œé¢è¯­è¨€</span>
          <div class="flex rounded-full border border-gray-200 bg-slate-50 text-[11px] overflow-hidden">
            <button class="lang-switch px-2.5 py-1 border-r border-gray-200 text-gray-600" data-lang="zh">ä¸­</button>
            <button class="lang-switch px-2.5 py-1 border-r border-gray-200 text-gray-600" data-lang="en">EN</button>
            <button class="lang-switch px-2.5 py-1 text-gray-600" data-lang="ko">í•œ</button>
          </div>
        </div>

        <!-- Tab åˆ‡æ¢ -->
        <div class="flex bg-slate-900/90 rounded-full p-1 shadow-sm">
          <button
            id="tabFinance"
            class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium bg-slate-900 text-sky-100 transition">
            ğŸ’° è´¢åŠ¡ç®¡ç†
          </button>
          <button
            id="tabStudy"
            class="px-4 py-1.5 rounded-full text-xs md:text-sm font-medium bg-transparent text-slate-100/80 hover:text-white hover:bg-slate-800 transition">
            ğŸ“š å­¦ä¹ æ—¶é—´
          </button>
        </div>
      </div>
    </header>

    <!-- è´¢åŠ¡æ¨¡å— -->
    <section id="finance-section">
      <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6">

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          <div class="bg-white p-6 rounded-xl shadow-sm border-l-4"
               :class="currentTab === 'subs' ? 'border-indigo-500' : 'border-red-500'">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
              {{ t.dailyAvgTitle }}
            </p>
            <p class="text-3xl font-bold mt-2 text-gray-800">
              Â¥ {{ calculateTotal('day').toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) }}
            </p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-sm border-l-4"
               :class="currentTab === 'subs' ? 'border-indigo-500' : 'border-red-500'">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
              {{ t.monthlyFixedTitle }}
            </p>
            <p class="text-3xl font-bold mt-2 text-gray-800">
              Â¥ {{ calculateTotal('month').toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) }}
            </p>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-sm border-l-4"
               :class="currentTab === 'subs' ? 'border-indigo-500' : 'border-red-500'">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
              {{ t.yearTotalTitle }}
            </p>
            <p class="text-3xl font-bold mt-2 text-gray-800">
              Â¥ {{ calculateTotal('year').toLocaleString('zh-CN', {minimumFractionDigits: 0, maximumFractionDigits: 0}) }}
            </p>
          </div>
        </section>

        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">
            <i class="fa-solid fa-plus-circle mr-2"></i>
            {{ currentTab === 'subs' ? t.addSubTitle : t.addDebtTitle }}
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-3">
            <input
              v-model="newItem.name"
              :placeholder="t.namePlaceholder"
              class="border rounded px-3 py-2 text-sm focus:ring-2 focus:outline-none md:col-span-2"
              :class="currentTab === 'subs' ? 'focus:ring-indigo-200' : 'focus:ring-red-200'">

            <div class="relative">
              <span class="absolute left-3 top-2 text-gray-400 text-sm">$</span>
              <input
                v-model.number="newItem.amount"
                type="number"
                :placeholder="t.amountPlaceholder"
                class="border rounded pl-6 pr-3 py-2 text-sm w-full focus:ring-2 focus:outline-none"
                :class="currentTab === 'subs' ? 'focus:ring-indigo-200' : 'focus:ring-red-200'">
            </div>

            <select v-model="newItem.currency" class="border rounded px-2 py-2 text-sm bg-white">
              <option value="CNY">CNY ({{ t.cny }})</option>
              <option value="USD">USD ({{ t.usd }})</option>
              <option value="EUR">EUR ({{ t.eur }})</option>
              <option value="JPY">JPY ({{ t.jpy }})</option>
              <option value="HKD">HKD ({{ t.hkd }})</option>
              <option value="GBP">GBP ({{ t.gbp }})</option>
            </select>

            <select v-model="newItem.period" class="border rounded px-2 py-2 text-sm bg-white">
              <option value="month">{{ t.periodMonthly }}</option>
              <option value="year">{{ t.periodYearly }}</option>
            </select>
          </div>
          <button
            @click="addItem"
            class="mt-4 w-full text-white font-bold py-2 px-4 rounded transition duration-200"
            :class="currentTab === 'subs' ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-red-600 hover:bg-red-700'">
            {{ t.confirmAdd }}
          </button>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h3 class="font-semibold text-gray-700">{{ t.detailListTitle }}</h3>
            <span class="text-xs text-gray-500">{{ t.detailListHint }}</span>
          </div>

          <div v-if="currentList.length === 0" class="p-8 text-center text-gray-400">
            {{ currentTab === 'subs' ? t.noSubData : t.noDebtData }}
          </div>

          <ul v-else class="divide-y divide-gray-100">
            <li
              v-for="(item, index) in currentList"
              :key="index"
              class="p-4 hover:bg-gray-50 flex justify-between items-center group">
              <div class="flex items-center">
                <div
                  class="w-10 h-10 rounded-full flex items-center justify-center mr-4"
                  :class="currentTab === 'subs' ? 'bg-indigo-100 text-indigo-600' : 'bg-red-100 text-red-600'">
                  <i class="fa-solid" :class="item.period === 'year' ? 'fa-calendar' : 'fa-calendar-day'"></i>
                </div>
                <div>
                  <p class="font-medium text-gray-800">{{ item.name }}</p>
                  <p class="text-xs text-gray-500">
                    {{ t.originalPrice }}: {{ item.currency }} {{ item.amount }}
                    / {{ item.period === 'year' ? t.perYear : t.perMonth }}
                  </p>
                </div>
              </div>

              <div class="text-right flex items-center gap-4">
                <div>
                  <p class="font-bold text-gray-700">
                    Â¥ {{ convertToMonthly(item).toFixed(1) }}
                  </p>
                  <p class="text-xs text-gray-400">/ {{ t.perMonth }}</p>
                </div>
                <button @click="deleteItem(index)" class="text-gray-300 hover:text-red-500 transition p-2">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </li>
          </ul>
        </div>

        <div class="mt-8 text-center text-xs text-gray-400">
          <p>{{ t.footerLine1 }}</p>
          <p>{{ t.footerLine2 }}</p>
        </div>

      </div>
    </section>

    <!-- å­¦ä¹ è®¡æ—¶æ¨¡å—ï¼ˆä¿æŒåŸæ¥çš„å¤šè¯­è¨€ + æ–°æ’ç‰ˆï¼‰ -->
    <section id="study-section" class="hidden">
      <div class="max-w-4xl mx-auto space-y-6">
        <!-- é¡¶éƒ¨ï¼šæ§åˆ¶åŒº + ä»Šæ—¥è¿›åº¦ -->
        <div class="bg-white rounded-2xl shadow-sm p-6 md:p-8">
          <div class="grid gap-6 md:grid-cols-[minmax(0,2.3fr)_minmax(0,2.1fr)] items-stretch">
            <!-- å·¦ï¼šæ ‡é¢˜ + æè¿° + å­˜å‚¨æç¤º -->
            <div class="flex flex-col justify-between gap-4">
              <div class="space-y-2">
                <h2 class="text-lg md:text-xl font-semibold text-gray-900 flex items-center">
                  <i class="fa-solid fa-stopwatch mr-2 text-sky-500"></i>
                  <span id="studyTitleText">å­¦ä¹ æ—¶é—´è®°å½•å™¨</span>
                </h2>
                <p id="studySubtitleText" class="text-xs md:text-sm text-gray-500 leading-relaxed">
                  é€‰æ‹©é¡¹ç›®ç‚¹å‡»ã€Œå¼€å§‹ã€ï¼Œç»“æŸæ—¶ç‚¹å‡»ã€Œç»“æŸå½“å‰ã€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç´¯è®¡å¹¶ç»Ÿè®¡è¶‹åŠ¿ã€‚
                </p>
              </div>
              <span
                class="inline-flex items-center px-3 py-1 rounded-full bg-slate-50 border border-dashed border-slate-200 text-[11px] text-gray-500">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 mr-2"></span>
                <span id="localHintText">æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆæœ¬æœºï¼‰ï¼›ç‚¹å‡» â˜ï¸ åŒæ­¥ å¯ä¸äº‘ç«¯åˆå¹¶ã€‚</span>
              </span>
            </div>

            <!-- å³ï¼šæ·±è‰²æ§åˆ¶é¢æ¿ -->
            <div class="bg-slate-900 rounded-2xl text-sky-100 px-4 py-4 md:px-5 md:py-5 flex flex-col gap-4">
              <!-- é¡¹ç›®é€‰æ‹© + è®¡æ—¶å±•ç¤º -->
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div class="flex-1">
                  <label
                    id="labelTask"
                    class="block text-[11px] uppercase tracking-wider text-sky-300 mb-1">
                    å­¦ä¹ é¡¹ç›®
                  </label>
                  <select
                    id="taskSelect"
                    class="w-full border-0 rounded-xl text-xs md:text-sm px-3 py-1.5 bg-slate-800 text-sky-50 focus:outline-none focus:ring-2 focus:ring-sky-400">
                  </select>
                </div>
                <div class="flex justify-start md:justify-end flex-1">
                  <div class="flex flex-col items-start md:items-end">
                    <span id="labelTimer" class="text-[11px] text-slate-400">å®æ—¶è®¡æ—¶</span>
                    <span
                      id="timerDisplay"
                      class="mt-1 font-mono text-xl md:text-2xl px-3 py-1 rounded-full bg-black/40 text-cyan-300 shadow-inner">
                      00:00:00
                    </span>
                  </div>
                </div>
              </div>

              <!-- æ§åˆ¶æŒ‰é’® -->
              <div class="flex flex-wrap items-center gap-2">
                <button
                  id="toggleButton"
                  class="inline-flex items-center justify-center px-4 py-2 rounded-full text-xs md:text-sm font-semibold bg-sky-500 text-white shadow-sm hover:bg-sky-600 transition">
                  â±ï¸ å¼€å§‹
                </button>
                <button
                  id="stopButton"
                  class="inline-flex items-center justify-center px-4 py-2 rounded-full text-xs md:text-sm border border-slate-500 text-slate-100 bg-transparent hover:bg-slate-800 transition"
                  disabled>
                  â¹ï¸ ç»“æŸå½“å‰
                </button>
              </div>

              <!-- è´¦å· + åŒæ­¥ + çŠ¶æ€ -->
              <div class="flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
                <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                  <input
                    id="accountIdInput"
                    class="border border-slate-600 rounded-full px-3 py-1.5 text-[11px] w-full sm:w-40 bg-slate-800 text-sky-50 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-300"
                    placeholder="è´¦å·IDï¼Œä¾‹å¦‚ dustin-main">
                  <button
                    id="syncButton"
                    class="inline-flex items-center justify-center px-3 py-1.5 rounded-full text-[11px] font-semibold bg-slate-100 text-slate-900 hover:bg-white transition">
                    â˜ï¸ åŒæ­¥
                  </button>
                </div>
                <p id="statusText" class="text-[11px] text-slate-300 mt-1 sm:mt-0">
                  å½“å‰æ— è¿›è¡Œä¸­çš„å­¦ä¹ 
                </p>
              </div>
            </div>
          </div>

          <!-- ä»Šæ—¥è¿›åº¦ï¼ˆåœ¨åŒä¸€å¡ç‰‡åº•éƒ¨ï¼‰ -->
          <div class="mt-5 border border-dashed border-gray-200 rounded-lg p-3">
            <div class="flex items-center justify-between mb-2">
              <span id="todayHeaderText" class="text-xs font-semibold text-gray-600">ğŸ“… ä»Šæ—¥è¿›åº¦ï¼ˆæŒ‰é¡¹ç›®ï¼‰</span>
              <span
                id="todayTotalBadge"
                class="inline-flex items-center px-2.5 py-1 rounded-full text-[11px] bg-slate-100 text-gray-600">
                ä»Šæ—¥æ€»å­¦ä¹ ï¼š0 åˆ†é’Ÿ
              </span>
            </div>
            <div
              id="todaySummaryGrid"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 text-xs">
              <!-- JS å¡«å…… -->
            </div>
          </div>
        </div>

        <!-- é¡¹ç›®ç®¡ç† -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 id="taskManageTitle" class="text-sm font-semibold text-gray-800">é¡¹ç›®ç®¡ç†</h3>
              <p id="taskManageSubtitle" class="text-xs text-gray-500 mt-1">
                æ·»åŠ  / åˆ é™¤è‡ªå®šä¹‰å­¦ä¹ é¡¹ç›®ï¼Œå¹¶è®¾ç½®æ¯æ—¥ç›®æ ‡åˆ†é’Ÿæ•°ã€‚
              </p>
            </div>
          </div>

          <div id="taskList" class="space-y-2 mb-4">
            <!-- JS å¡«å…… é¡¹ç›®åˆ—è¡¨ -->
          </div>

          <div class="border-t border-gray-100 pt-3 mt-3">
            <p id="taskNewTitle" class="text-xs font-semibold text-gray-600 mb-2">æ–°å¢é¡¹ç›®</p>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-2">
              <input
                id="newTaskNameZh"
                class="border rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-200"
                placeholder="åç§°ï¼ˆä¸­æ–‡ï¼‰">
              <input
                id="newTaskNameEn"
                class="border rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-200"
                placeholder="Name (English)">
              <input
                id="newTaskNameKo"
                class="border rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-200"
                placeholder="ì´ë¦„ (í•œêµ­ì–´)">
              <input
                id="newTaskGoal"
                type="number"
                min="0"
                class="border rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-200"
                placeholder="æ¯æ—¥ç›®æ ‡åˆ†é’Ÿ">
            </div>
            <button
              id="addTaskButton"
              class="mt-3 inline-flex items-center px-4 py-2 rounded-full text-xs font-semibold bg-emerald-500 text-white hover:bg-emerald-600 transition">
              â• æ·»åŠ é¡¹ç›®
            </button>
          </div>
        </div>

        <!-- æœ€è¿‘ 7 å¤©å›¾è¡¨ -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 id="weeklyTitle" class="text-sm font-semibold text-gray-800">æœ€è¿‘ 7 å¤©æ€»å­¦ä¹ æ—¶é•¿</h3>
              <p id="weeklySubtitle" class="text-xs text-gray-500 mt-1">
                æŒ‰å¤©ç»Ÿè®¡æ‰€æœ‰é¡¹ç›®æ€»æ—¶é•¿ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰ã€‚
              </p>
            </div>
          </div>
          <div class="h-48">
            <canvas id="weeklyChart"></canvas>
          </div>
        </div>

        <!-- å†å²è®°å½• -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 id="historyTitle" class="text-sm font-semibold text-gray-800">æœ€è¿‘å­¦ä¹ è®°å½•</h3>
              <p id="historySubtitle" class="text-xs text-gray-500 mt-1">
                æ˜¾ç¤ºæœ€è¿‘è‹¥å¹²æ¬¡å­¦ä¹ çš„å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´å’Œæ—¶é•¿ã€‚
              </p>
            </div>
            <button
              id="clearAllButton"
              class="inline-flex items-center px-3 py-1.5 rounded-full text-xs border border-red-200 text-red-500 bg-red-50 hover:bg-red-100 transition">
              ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è®°å½•
            </button>
          </div>
          <div class="overflow-x-auto text-sm">
            <table class="min-w-full border-t border-gray-100">
              <thead class="bg-slate-50 text-gray-500 text-xs">
              <tr>
                <th class="px-2 py-1 text-left" id="thDate">æ—¥æœŸ</th>
                <th class="px-2 py-1 text-left" id="thTask">é¡¹ç›®</th>
                <th class="px-2 py-1 text-left" id="thStart">å¼€å§‹</th>
                <th class="px-2 py-1 text-left" id="thEnd">ç»“æŸ</th>
                <th class="px-2 py-1 text-right" id="thDuration">æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</th>
              </tr>
              </thead>
              <tbody id="historyBody" class="divide-y divide-gray-100">
              </tbody>
            </table>
            <p id="historyEmpty" class="text-xs text-gray-400 mt-3">
              æš‚æ— å­¦ä¹ è®°å½•ï¼Œå¼€å§‹ä¸€æ¬¡å­¦ä¹ åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä½ çš„å†å²ã€‚
            </p>
          </div>
          <p class="text-[11px] text-gray-400 mt-3">
            æç¤ºï¼šåˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±æ•°æ®ï¼›å¦‚éœ€å®Œå…¨é‡ç½®ï¼Œå¯ç‚¹å‡»ã€Œæ¸…ç©ºæ‰€æœ‰è®°å½•ã€ã€‚
          </p>
        </div>
      </div>
    </section>
  </div>

  <!-- é¡¶éƒ¨ Tab åˆ‡æ¢è„šæœ¬ -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tabFinance = document.getElementById('tabFinance');
      const tabStudy = document.getElementById('tabStudy');
      const financeSection = document.getElementById('finance-section');
      const studySection = document.getElementById('study-section');

      const activeClasses = ['bg-slate-900', 'text-sky-100'];
      const inactiveClasses = ['bg-transparent', 'text-slate-100/80'];

      function setActive(tab, isActive) {
        if (!tab) return;
        if (isActive) {
          tab.classList.add(...activeClasses);
          tab.classList.remove(...inactiveClasses);
        } else {
          tab.classList.remove(...activeClasses);
          tab.classList.add(...inactiveClasses);
        }
      }

      function activateTab(name) {
        if (name === 'finance') {
          financeSection.classList.remove('hidden');
          studySection.classList.add('hidden');
          setActive(tabFinance, true);
          setActive(tabStudy, false);
        } else {
          financeSection.classList.add('hidden');
          studySection.classList.remove('hidden');
          setActive(tabFinance, false);
          setActive(tabStudy, true);
        }
      }

      tabFinance.addEventListener('click', () => activateTab('finance'));
      tabStudy.addEventListener('click', () => activateTab('study'));

      activateTab('finance');
    });
  </script>

  <!-- Vue è´¢åŠ¡ç³»ç»Ÿè„šæœ¬ï¼ˆå¸¦å¤šè¯­è¨€ï¼‰ -->
  <script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    const financeI18N = {
      zh: {
        dailyAvgTitle: 'æ¯æ—¥å‡æ‘Š (CNY)',
        monthlyFixedTitle: 'æ¯æœˆå›ºå®š (CNY)',
        yearTotalTitle: 'å¹´åº¦æ€»æˆæœ¬ (CNY)',
        addSubTitle: 'æ·»åŠ è®¢é˜…é¡¹ç›®',
        addDebtTitle: 'æ·»åŠ å€ºåŠ¡',
        namePlaceholder: 'é¡¹ç›®åç§° ',
        amountPlaceholder: 'é‡‘é¢',
        cny: 'äººæ°‘å¸',
        usd: 'ç¾å…ƒ',
        eur: 'æ¬§å…ƒ',
        jpy: 'æ—¥å…ƒ',
        hkd: 'æ¸¯å¸',
        gbp: 'è‹±é•‘',
        periodMonthly: 'æ¯æœˆä»˜',
        periodYearly: 'æ¯å¹´ä»˜',
        confirmAdd: 'ç¡®è®¤æ·»åŠ ',
        detailListTitle: 'è¯¦ç»†æ¸…å•',
        detailListHint: 'è‡ªåŠ¨æ¢ç®—ä¸º CNY å±•ç¤º',
        noSubData: 'æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ æ‚¨çš„ç¬¬ä¸€ç¬”è®¢é˜…ã€‚',
        noDebtData: 'æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ æ‚¨çš„ç¬¬ä¸€ç¬”å€ºåŠ¡ã€‚',
        originalPrice: 'åŸä»·',
        perMonth: 'æœˆ',
        perYear: 'å¹´',
        footerLine1: 'æ•°æ®å­˜å‚¨åœ¨æ‚¨çš„æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œæ¸…é™¤ç¼“å­˜å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚',
        footerLine2: 'æ±‡ç‡æ•°æ®æ¥æº: ExchangeRate-API'
      },
      en: {
        dailyAvgTitle: 'Daily average (CNY)',
        monthlyFixedTitle: 'Monthly total (CNY)',
        yearTotalTitle: 'Yearly total (CNY)',
        addSubTitle: 'Add subscription',
        addDebtTitle: 'Add debt',
        namePlaceholder: 'Item name ',
        amountPlaceholder: 'Amount',
        cny: 'CNY',
        usd: 'USD',
        eur: 'EUR',
        jpy: 'JPY',
        hkd: 'HKD',
        gbp: 'GBP',
        periodMonthly: 'Monthly',
        periodYearly: 'Yearly',
        confirmAdd: 'Add',
        detailListTitle: 'Detail list',
        detailListHint: 'Converted to CNY for display',
        noSubData: 'No data yet. Please add your first subscription.',
        noDebtData: 'No data yet. Please add your first debt item.',
        originalPrice: 'Original',
        perMonth: 'month',
        perYear: 'year',
        footerLine1: 'Data is stored in your local browser. Clearing cache may remove all records.',
        footerLine2: 'Exchange rates powered by ExchangeRate-API.'
      },
      ko: {
        dailyAvgTitle: 'ì¼ì¼ í‰ê·  (CNY)',
        monthlyFixedTitle: 'ì›” ê³ ì • ë¹„ìš© (CNY)',
        yearTotalTitle: 'ì—°ê°„ ì´ ë¹„ìš© (CNY)',
        addSubTitle: 'êµ¬ë… í•­ëª© ì¶”ê°€',
        addDebtTitle: 'ë¶€ì±„ ì¶”ê°€',
        namePlaceholder: 'í•­ëª© ì´ë¦„ ',
        amountPlaceholder: 'ê¸ˆì•¡',
        cny: 'ìœ„ì•ˆ',
        usd: 'ë‹¬ëŸ¬',
        eur: 'ìœ ë¡œ',
        jpy: 'ì—”',
        hkd: 'í™ì½©ë‹¬ëŸ¬',
        gbp: 'íŒŒìš´ë“œ',
        periodMonthly: 'ì›” ë‚©ë¶€',
        periodYearly: 'ì—° ë‚©ë¶€',
        confirmAdd: 'ì¶”ê°€í•˜ê¸°',
        detailListTitle: 'ìƒì„¸ ëª©ë¡',
        detailListHint: 'í‘œì‹œëŠ” CNY ê¸°ì¤€ìœ¼ë¡œ í™˜ì‚°ë©ë‹ˆë‹¤.',
        noSubData: 'ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« êµ¬ë… í•­ëª©ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.',
        noDebtData: 'ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¶€ì±„ í•­ëª©ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.',
        originalPrice: 'ì›ê°€',
        perMonth: 'ì›”',
        perYear: 'ë…„',
        footerLine1: 'ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ë©°, ìºì‹œë¥¼ ì‚­ì œí•˜ë©´ ê¸°ë¡ì´ ì§€ì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
        footerLine2: 'í™˜ìœ¨ ë°ì´í„°: ExchangeRate-API.'
      }
    };

    createApp({
      setup() {
        const currentTab = ref('subs');
        const rates = ref({});
        const subscriptions = ref([]);
        const debts = ref([]);
        const newItem = ref({
          name: '',
          amount: '',
          currency: 'USD',
          period: 'month'
        });

        const appLang = ref(window.__dashboardLang || localStorage.getItem('studyLang_v1') || 'zh');
        const t = computed(() => financeI18N[appLang.value] || financeI18N.zh);

        window.__updateFinanceLang = (newLang) => {
          appLang.value = newLang;
        };

        const fetchRates = async () => {
          try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/CNY');
            const data = await res.json();

            const cnyBasedRates = {};
            for (const [key, value] of Object.entries(data.rates)) {
              cnyBasedRates[key] = 1 / value;
            }
            cnyBasedRates['CNY'] = 1;
            rates.value = cnyBasedRates;
          } catch (e) {
            console.error("æ±‡ç‡è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼", e);
            rates.value = { USD: 7.2, CNY: 1, EUR: 7.8, JPY: 0.048, HKD: 0.92, GBP: 9.1 };
          }
        };

        const convertToMonthly = (item) => {
          if (!item.amount || !rates.value[item.currency]) return 0;

          const rate = rates.value[item.currency];
          let monthlyCNY = 0;

          if (item.period === 'month') {
            monthlyCNY = item.amount * rate;
          } else if (item.period === 'year') {
            monthlyCNY = (item.amount * rate) / 12;
          }

          return monthlyCNY;
        };

        const calculateTotal = (scale) => {
          const list = currentTab.value === 'subs' ? subscriptions.value : debts.value;
          let totalMonthly = list.reduce((sum, item) => sum + convertToMonthly(item), 0);

          if (scale === 'month') return totalMonthly;
          if (scale === 'year') return totalMonthly * 12;
          if (scale === 'day') return totalMonthly / 30.44;
          return 0;
        };

        const addItem = () => {
          if (!newItem.value.name || !newItem.value.amount) {
            alert(appLang.value === 'en' ? 'Please fill all fields.' : 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            return;
          }
          const list = currentTab.value === 'subs' ? subscriptions.value : debts.value;
          list.push({ ...newItem.value });

          newItem.value.name = '';
          newItem.value.amount = '';
        };

        const deleteItem = (index) => {
          const list = currentTab.value === 'subs' ? subscriptions.value : debts.value;
          list.splice(index, 1);
        };

        const currentList = computed(() => {
          return currentTab.value === 'subs' ? subscriptions.value : debts.value;
        });

        onMounted(() => {
          fetchRates();
          const savedSubs = localStorage.getItem('my_finance_subs');
          const savedDebts = localStorage.getItem('my_finance_debts');
          if (savedSubs) subscriptions.value = JSON.parse(savedSubs);
          if (savedDebts) debts.value = JSON.parse(savedDebts);
        });

        watch(subscriptions, (newVal) => localStorage.setItem('my_finance_subs', JSON.stringify(newVal)), { deep: true });
        watch(debts, (newVal) => localStorage.setItem('my_finance_debts', JSON.stringify(newVal)), { deep: true });

        return {
          currentTab,
          newItem,
          addItem,
          deleteItem,
          rates,
          currentList,
          calculateTotal,
          convertToMonthly,
          t,
          appLang
        };
      }
    }).mount('#app');
  </script>

  <!-- å­¦ä¹ è®¡æ—¶å™¨è„šæœ¬ï¼ˆåŸæœ‰å¤šè¯­è¨€ + åŒæ­¥ financeï¼‰ -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (!document.getElementById('study-section')) return;

      const SUPABASE_URL = 'https://xclzhqevtkaheaupzfdk.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbHpocWV2dGthaGVhdXB6ZmRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxOTYxMjIsImV4cCI6MjA3OTc3MjEyMn0.OYmKjQK6DsFyzsU9ugmF-X0oNDCPSFdXb6Qb5cxrcIc';

      const supabaseClient =
        window.supabase && window.supabase.createClient
          ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
          : null;

      const ACCOUNT_ID_STORAGE_KEY = 'studyAccountId_v1';

      const TASKS_STORAGE_KEY = 'studyTasks_v1';
      const SESSIONS_STORAGE_KEY = 'studySessions_v1';
      const CURRENT_SESSION_KEY = 'currentStudySession_v1';
      const LANG_STORAGE_KEY = 'studyLang_v1';

      const DEFAULT_TASKS = [
        {
          id: 'ielts',
          names: { zh: 'é›…æ€', en: 'IELTS', ko: 'ì•„ì´ì—˜ì¸ ' },
          goal: 120
        },
        {
          id: 'python',
          names: { zh: 'Python', en: 'Python', ko: 'íŒŒì´ì¬' },
          goal: 30
        },
        {
          id: 'economics',
          names: { zh: 'ç»æµ / é‡‘è', en: 'Economics / Finance', ko: 'ê²½ì œ / ê¸ˆìœµ' },
          goal: 20
        },
        {
          id: 'fitness',
          names: { zh: 'å¥èº«', en: 'Workout', ko: 'ìš´ë™' },
          goal: 30
        }
      ];

      const I18N = {
        zh: {
          financeTab: 'ğŸ’° è´¢åŠ¡ç®¡ç†',
          studyTab: 'ğŸ“š å­¦ä¹ è®¡æ—¶å™¨',
          studyTitle: 'å­¦ä¹ æ—¶é—´è®°å½•å™¨',
          studySubtitle: 'é€‰æ‹©é¡¹ç›®ç‚¹å‡»ã€Œå¼€å§‹ã€ï¼Œç»“æŸæ—¶ç‚¹å‡»ã€Œç»“æŸå½“å‰ã€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç´¯è®¡å¹¶ç»Ÿè®¡è¶‹åŠ¿ã€‚',
          localHint: 'æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆæœ¬æœºï¼‰ï¼›ç‚¹å‡» â˜ï¸ åŒæ­¥ å¯ä¸äº‘ç«¯åˆå¹¶ã€‚',
          labelTask: 'å­¦ä¹ é¡¹ç›®',
          labelTimer: 'å®æ—¶è®¡æ—¶',
          btnStart: 'â±ï¸ å¼€å§‹',
          btnPause: 'â¸ï¸ æš‚åœå¹¶ä¿å­˜',
          btnStop: 'â¹ï¸ ç»“æŸå½“å‰',
          statusIdle: 'å½“å‰æ— è¿›è¡Œä¸­çš„å­¦ä¹ ',
          statusRunningPrefix: 'æ­£åœ¨å­¦ä¹ ï¼š',
          statusRunningAt: 'Â· å¼€å§‹äº ',
          todayHeader: 'ğŸ“… ä»Šæ—¥è¿›åº¦ï¼ˆæŒ‰é¡¹ç›®ï¼‰',
          todayTotalPrefix: 'ä»Šæ—¥æ€»å­¦ä¹ ï¼š',
          todayTotalSuffix: ' åˆ†é’Ÿ',
          taskManageTitle: 'é¡¹ç›®ç®¡ç†',
          taskManageSubtitle: 'æ·»åŠ  / åˆ é™¤è‡ªå®šä¹‰å­¦ä¹ é¡¹ç›®ï¼Œå¹¶è®¾ç½®æ¯æ—¥ç›®æ ‡åˆ†é’Ÿæ•°ã€‚',
          taskNewTitle: 'æ–°å¢é¡¹ç›®',
          taskListEmpty: 'æš‚æ— é¡¹ç›®ï¼Œè¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªå­¦ä¹ é¡¹ç›®ã€‚',
          taskGoalLabel: 'ç›®æ ‡ï¼š',
          taskGoalUnit: ' åˆ†é’Ÿ / å¤©',
          btnAddTask: 'â• æ·»åŠ é¡¹ç›®',
          weeklyTitle: 'æœ€è¿‘ 7 å¤©æ€»å­¦ä¹ æ—¶é•¿',
          weeklySubtitle: 'æŒ‰å¤©ç»Ÿè®¡æ‰€æœ‰é¡¹ç›®æ€»æ—¶é•¿ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰ã€‚',
          historyTitle: 'æœ€è¿‘å­¦ä¹ è®°å½•',
          historySubtitle: 'æ˜¾ç¤ºæœ€è¿‘è‹¥å¹²æ¬¡å­¦ä¹ çš„å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´å’Œæ—¶é•¿ã€‚',
          thDate: 'æ—¥æœŸ',
          thTask: 'é¡¹ç›®',
          thStart: 'å¼€å§‹',
          thEnd: 'ç»“æŸ',
          thDuration: 'æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰',
          btnClearAll: 'ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è®°å½•',
          historyEmpty: 'æš‚æ— å­¦ä¹ è®°å½•ï¼Œå¼€å§‹ä¸€æ¬¡å­¦ä¹ åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä½ çš„å†å²ã€‚',
          deletedTask: '[å·²åˆ é™¤é¡¹ç›®]',
          syncWorking: 'æ­£åœ¨ä¸äº‘ç«¯åŒæ­¥â€¦',
          syncDone: 'åŒæ­¥å®Œæˆ',
          syncNeedId: 'è¯·å…ˆè¾“å…¥è´¦å· IDï¼ˆä¾‹å¦‚ dustin-mainï¼‰',
          syncError: 'åŒæ­¥å¤±è´¥ï¼š'
        },
        en: {
          financeTab: 'ğŸ’° Finance',
          studyTab: 'ğŸ“š Study Tracker',
          studyTitle: 'Study Time Tracker',
          studySubtitle: 'Select a task and click "Start". Click "Stop" to save the session and update stats.',
          localHint: 'Data is stored locally. Click â˜ï¸ to sync with cloud.',
          labelTask: 'Study task',
          labelTimer: 'Timer',
          btnStart: 'â±ï¸ Start',
          btnPause: 'â¸ï¸ Pause & Save',
          btnStop: 'â¹ï¸ Stop',
          statusIdle: 'No active session.',
          statusRunningPrefix: 'Now studying: ',
          statusRunningAt: 'Â· started at ',
          todayHeader: 'ğŸ“… Today (by task)',
          todayTotalPrefix: 'Total today: ',
          todayTotalSuffix: ' min',
          taskManageTitle: 'Task management',
          taskManageSubtitle: 'Add / remove custom study tasks and set daily goals (minutes).',
          taskNewTitle: 'New task',
          taskListEmpty: 'No tasks yet. Please add at least one study task.',
          taskGoalLabel: 'Goal: ',
          taskGoalUnit: ' min / day',
          btnAddTask: 'â• Add task',
          weeklyTitle: 'Last 7 days total study time',
          weeklySubtitle: 'Total minutes per day across all tasks.',
          historyTitle: 'Recent sessions',
          historySubtitle: 'Shows recent study sessions with start, end and duration.',
          thDate: 'Date',
          thTask: 'Task',
          thStart: 'Start',
          thEnd: 'End',
          thDuration: 'Duration (min)',
          btnClearAll: 'ğŸ§¹ Clear all',
          historyEmpty: 'No sessions yet. Start studying to see history here.',
          deletedTask: '[deleted task]',
          syncWorking: 'Syncing with cloudâ€¦',
          syncDone: 'Sync finished',
          syncNeedId: 'Please enter an account ID first (e.g. dustin-main).',
          syncError: 'Sync failed: '
        },
        ko: {
          financeTab: 'ğŸ’° ì¬ë¬´ ê´€ë¦¬',
          studyTab: 'ğŸ“š ê³µë¶€ íƒ€ì´ë¨¸',
          studyTitle: 'ê³µë¶€ ì‹œê°„ ê¸°ë¡ê¸°',
          studySubtitle: 'í•­ëª©ì„ ì„ íƒí•˜ê³ ã€Œì‹œì‘ã€ì„ ëˆ„ë¥´ì„¸ìš”. ëë‚˜ë©´ã€Œì •ì§€ã€ë¥¼ ëˆŒëŸ¬ ê¸°ë¡í•©ë‹ˆë‹¤.',
          localHint: 'ë°ì´í„°ëŠ” ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤. â˜ï¸ ë²„íŠ¼ìœ¼ë¡œ í´ë¼ìš°ë“œì™€ ë™ê¸°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
          labelTask: 'ê³µë¶€ í•­ëª©',
          labelTimer: 'íƒ€ì´ë¨¸',
          btnStart: 'â±ï¸ ì‹œì‘',
          btnPause: 'â¸ï¸ ì¼ì‹œì •ì§€ & ì €ì¥',
          btnStop: 'â¹ï¸ ì •ì§€',
          statusIdle: 'ì§„í–‰ ì¤‘ì¸ ê³µë¶€ê°€ ì—†ìŠµë‹ˆë‹¤.',
          statusRunningPrefix: 'ê³µë¶€ ì¤‘: ',
          statusRunningAt: 'Â· ì‹œì‘ ì‹œê°„ ',
          todayHeader: 'ğŸ“… ì˜¤ëŠ˜ ì§„í–‰ ìƒí™© (í•­ëª©ë³„)',
          todayTotalPrefix: 'ì˜¤ëŠ˜ ì´ ê³µë¶€: ',
          todayTotalSuffix: ' ë¶„',
          taskManageTitle: 'í•­ëª© ê´€ë¦¬',
          taskManageSubtitle: 'ê³µë¶€ í•­ëª©ì„ ì¶”ê°€/ì‚­ì œí•˜ê³  í•˜ë£¨ ëª©í‘œ ì‹œê°„ì„ ì„¤ì •í•©ë‹ˆë‹¤.',
          taskNewTitle: 'ìƒˆ í•­ëª©',
          taskListEmpty: 'ì•„ì§ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê³µë¶€ í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.',
          taskGoalLabel: 'ëª©í‘œ: ',
          taskGoalUnit: ' ë¶„ / ì¼',
          btnAddTask: 'â• í•­ëª© ì¶”ê°€',
          weeklyTitle: 'ìµœê·¼ 7ì¼ ê³µë¶€ ì´ ì‹œê°„',
          weeklySubtitle: 'ëª¨ë“  í•­ëª©ì„ í•©ì¹œ í•˜ë£¨ë³„ ë¶„ëŸ‰ì…ë‹ˆë‹¤.',
          historyTitle: 'ìµœê·¼ ê³µë¶€ ê¸°ë¡',
          historySubtitle: 'ê³µë¶€ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ê³¼ ì†Œìš” ì‹œê°„ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.',
          thDate: 'ë‚ ì§œ',
          thTask: 'í•­ëª©',
          thStart: 'ì‹œì‘',
          thEnd: 'ì¢…ë£Œ',
          thDuration: 'ì†Œìš” ì‹œê°„(ë¶„)',
          btnClearAll: 'ğŸ§¹ ì „ì²´ ì‚­ì œ',
          historyEmpty: 'ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê³µë¶€ë¥¼ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.',
          deletedTask: '[ì‚­ì œëœ í•­ëª©]',
          syncWorking: 'í´ë¼ìš°ë“œì™€ ë™ê¸°í™” ì¤‘â€¦',
          syncDone: 'ë™ê¸°í™” ì™„ë£Œ',
          syncNeedId: 'ë¨¼ì € ê³„ì • IDë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: dustin-main)',
          syncError: 'ë™ê¸°í™” ì‹¤íŒ¨: '
        }
      };

      let currentLang = localStorage.getItem(LANG_STORAGE_KEY) || 'zh';
      window.__dashboardLang = currentLang;

      let tasks = [];
      let sessions = [];
      let currentSession = null;
      let timerId = null;
      let weeklyChart = null;
      let currentAccountId = localStorage.getItem(ACCOUNT_ID_STORAGE_KEY) || '';

      const tabFinanceEl = document.getElementById('tabFinance');
      const tabStudyEl = document.getElementById('tabStudy');

      const studyTitleTextEl = document.getElementById('studyTitleText');
      const studySubtitleTextEl = document.getElementById('studySubtitleText');
      const localHintTextEl = document.getElementById('localHintText');
      const labelTaskEl = document.getElementById('labelTask');
      const labelTimerEl = document.getElementById('labelTimer');

      const taskSelectEl = document.getElementById('taskSelect');
      const toggleButtonEl = document.getElementById('toggleButton');
      const stopButtonEl = document.getElementById('stopButton');
      const timerDisplayEl = document.getElementById('timerDisplay');
      const statusTextEl = document.getElementById('statusText');

      const todayHeaderTextEl = document.getElementById('todayHeaderText');
      const todayTotalBadgeEl = document.getElementById('todayTotalBadge');
      const todaySummaryGridEl = document.getElementById('todaySummaryGrid');

      const taskListEl = document.getElementById('taskList');
      const newTaskNameZhEl = document.getElementById('newTaskNameZh');
      const newTaskNameEnEl = document.getElementById('newTaskNameEn');
      const newTaskNameKoEl = document.getElementById('newTaskNameKo');
      const newTaskGoalEl = document.getElementById('newTaskGoal');
      const addTaskButtonEl = document.getElementById('addTaskButton');

      const taskManageTitleEl = document.getElementById('taskManageTitle');
      const taskManageSubtitleEl = document.getElementById('taskManageSubtitle');
      const taskNewTitleEl = document.getElementById('taskNewTitle');

      const weeklyTitleEl = document.getElementById('weeklyTitle');
      const weeklySubtitleEl = document.getElementById('weeklySubtitle');

      const historyTitleEl = document.getElementById('historyTitle');
      const historySubtitleEl = document.getElementById('historySubtitle');
      const historyBodyEl = document.getElementById('historyBody');
      const historyEmptyEl = document.getElementById('historyEmpty');
      const clearAllButtonEl = document.getElementById('clearAllButton');

      const thDateEl = document.getElementById('thDate');
      const thTaskEl = document.getElementById('thTask');
      const thStartEl = document.getElementById('thStart');
      const thEndEl = document.getElementById('thEnd');
      const thDurationEl = document.getElementById('thDuration');

      const langButtons = document.querySelectorAll('.lang-switch');

      const accountIdInputEl = document.getElementById('accountIdInput');
      const syncButtonEl = document.getElementById('syncButton');

      if (accountIdInputEl) {
        accountIdInputEl.value = currentAccountId;
      }

      function loadTasks() {
        try {
          const raw = localStorage.getItem(TASKS_STORAGE_KEY);
          if (!raw) {
            tasks = DEFAULT_TASKS.slice();
            saveTasks();
          } else {
            const parsed = JSON.parse(raw);
            tasks = Array.isArray(parsed) ? parsed : DEFAULT_TASKS.slice();
          }
        } catch {
          tasks = DEFAULT_TASKS.slice();
          saveTasks();
        }
      }

      function saveTasks() {
        localStorage.setItem(TASKS_STORAGE_KEY, JSON.stringify(tasks));
      }

      function loadSessions() {
        try {
          const raw = localStorage.getItem(SESSIONS_STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function saveSessions() {
        localStorage.setItem(SESSIONS_STORAGE_KEY, JSON.stringify(sessions));
      }

      function loadCurrentSession() {
        try {
          const raw = localStorage.getItem(CURRENT_SESSION_KEY);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || !parsed.taskId || !parsed.start) return null;
          return parsed;
        } catch {
          return null;
        }
      }

      function saveCurrentSession(session) {
        localStorage.setItem(CURRENT_SESSION_KEY, JSON.stringify(session));
      }

      function clearCurrentSession() {
        localStorage.removeItem(CURRENT_SESSION_KEY);
      }

      function setCurrentAccountId(id) {
        currentAccountId = (id || '').trim();
        localStorage.setItem(ACCOUNT_ID_STORAGE_KEY, currentAccountId);
      }

      function computeDurationMinutes(startISO, endISO) {
        const start = new Date(startISO);
        const end = new Date(endISO);
        const diffMs = end - start;
        if (isNaN(diffMs) || diffMs <= 0) return 0;
        return diffMs / 60000;
      }

      function formatTimeHM(date) {
        return date.toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });
      }

      function formatDateYMD(date) {
        return date.toLocaleDateString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      }

      function formatTimerDisplay(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        const pad = n => String(n).padStart(2, '0');
        return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
      }

      function isSameDate(a, b) {
        return (
          a.getFullYear() === b.getFullYear() &&
          a.getMonth() === b.getMonth() &&
          a.getDate() === b.getDate()
        );
      }

      function getTodaySessions(all) {
        const today = new Date();
        return all.filter(s => isSameDate(new Date(s.start), today));
      }

      function sumByTask(sessionsList) {
        const result = {};
        for (const s of sessionsList) {
          if (!s.end) continue;
          const minutes = computeDurationMinutes(s.start, s.end);
          result[s.taskId] = (result[s.taskId] || 0) + minutes;
        }
        return result;
      }

      function sumTotalMinutes(sessionsList) {
        return sessionsList.reduce((acc, s) => {
          if (!s.end) return acc;
          return acc + computeDurationMinutes(s.start, s.end);
        }, 0);
      }

      function getLastNDaysDates(n) {
        const out = [];
        const now = new Date();
        for (let i = n - 1; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          out.push(d);
        }
        return out;
      }

      function slugify(text) {
        return (
          text
            .toString()
            .toLowerCase()
            .trim()
            .replace(/\s+/g, '-')
            .replace(/[^\w\-]+/g, '')
            .substring(0, 24) || `task_${Date.now()}`
        );
      }

      function getTaskById(id) {
        return tasks.find(t => t.id === id) || null;
      }

      function getTaskDisplayName(task) {
        const dict = I18N[currentLang] || I18N.zh;
        if (!task) return dict.deletedTask;
        const n = task.names || {};
        return n[currentLang] || n.zh || n.en || n.ko || task.id;
      }

      function applyLang() {
        const dict = I18N[currentLang] || I18N.zh;
        localStorage.setItem(LANG_STORAGE_KEY, currentLang);
        window.__dashboardLang = currentLang;
        if (window.__updateFinanceLang) window.__updateFinanceLang(currentLang);

        if (tabFinanceEl) tabFinanceEl.textContent = dict.financeTab;
        if (tabStudyEl) tabStudyEl.textContent = dict.studyTab;

        if (studyTitleTextEl) studyTitleTextEl.textContent = dict.studyTitle;
        if (studySubtitleTextEl) studySubtitleTextEl.textContent = dict.studySubtitle;
        if (localHintTextEl) localHintTextEl.textContent = dict.localHint;
        if (labelTaskEl) labelTaskEl.textContent = dict.labelTask;
        if (labelTimerEl) labelTimerEl.textContent = dict.labelTimer;

        if (todayHeaderTextEl) todayHeaderTextEl.textContent = dict.todayHeader;

        if (taskManageTitleEl) taskManageTitleEl.textContent = dict.taskManageTitle;
        if (taskManageSubtitleEl) taskManageSubtitleEl.textContent = dict.taskManageSubtitle;
        if (taskNewTitleEl) taskNewTitleEl.textContent = dict.taskNewTitle;

        if (weeklyTitleEl) weeklyTitleEl.textContent = dict.weeklyTitle;
        if (weeklySubtitleEl) weeklySubtitleEl.textContent = dict.weeklySubtitle;

        if (historyTitleEl) historyTitleEl.textContent = dict.historyTitle;
        if (historySubtitleEl) historySubtitleEl.textContent = dict.historySubtitle;

        if (thDateEl) thDateEl.textContent = dict.thDate;
        if (thTaskEl) thTaskEl.textContent = dict.thTask;
        if (thStartEl) thStartEl.textContent = dict.thStart;
        if (thEndEl) thEndEl.textContent = dict.thEnd;
        if (thDurationEl) thDurationEl.textContent = dict.thDuration;

        if (clearAllButtonEl) clearAllButtonEl.textContent = dict.btnClearAll;

        updateStatusUI();
        renderTodaySummary();
        renderTaskList();
        renderHistory();
        highlightLangButtons();
      }

      function highlightLangButtons() {
        langButtons.forEach(btn => {
          const lang = btn.getAttribute('data-lang');
          if (lang === currentLang) {
            btn.classList.add('bg-sky-500', 'text-white');
            btn.classList.remove('text-gray-600');
          } else {
            btn.classList.remove('bg-sky-500', 'text-white');
            btn.classList.add('text-gray-600');
          }
        });
      }

      function startTimerLoop() {
        if (!currentSession || timerId !== null) return;
        timerId = setInterval(() => {
          const now = new Date();
          const start = new Date(currentSession.start);
          const elapsed = Math.max(0, Math.floor((now - start) / 1000));
          if (timerDisplayEl) {
            timerDisplayEl.textContent = formatTimerDisplay(elapsed);
          }
        }, 1000);
      }

      function stopTimerLoop() {
        if (timerId !== null) {
          clearInterval(timerId);
          timerId = null;
        }
      }

      function updateStatusUI() {
        const dict = I18N[currentLang] || I18N.zh;
        if (!statusTextEl || !toggleButtonEl || !stopButtonEl) return;

        if (currentSession) {
          const task = getTaskById(currentSession.taskId);
          const start = new Date(currentSession.start);
          statusTextEl.textContent =
            dict.statusRunningPrefix +
            getTaskDisplayName(task) +
            dict.statusRunningAt +
            formatTimeHM(start);
          toggleButtonEl.textContent = dict.btnPause;
          stopButtonEl.disabled = false;
        } else {
          statusTextEl.textContent = dict.statusIdle;
          toggleButtonEl.textContent = dict.btnStart;
          stopButtonEl.disabled = true;
          if (timerDisplayEl) timerDisplayEl.textContent = '00:00:00';
        }
      }

      function renderTaskSelect() {
        if (!taskSelectEl) return;
        taskSelectEl.innerHTML = '';
        tasks.forEach(task => {
          const opt = document.createElement('option');
          opt.value = task.id;
          opt.textContent = getTaskDisplayName(task);
          taskSelectEl.appendChild(opt);
        });
      }

      function renderTaskList() {
        const dict = I18N[currentLang] || I18N.zh;
        if (!taskListEl) return;
        taskListEl.innerHTML = '';

        if (!tasks.length) {
          const p = document.createElement('p');
          p.className = 'text-xs text-gray-400';
          p.textContent = dict.taskListEmpty;
          taskListEl.appendChild(p);
          return;
        }

        tasks.forEach(task => {
          const wrapper = document.createElement('div');
          wrapper.className = 'flex items-center justify-between text-xs border border-gray-100 rounded-lg px-3 py-2 bg-slate-50';

          const left = document.createElement('div');
          left.className = 'flex flex-col';
          const nameSpan = document.createElement('span');
          nameSpan.className = 'font-semibold text-gray-800';
          nameSpan.textContent = getTaskDisplayName(task);
          const goalSpan = document.createElement('span');
          goalSpan.className = 'text-[11px] text-gray-500';
          const goal = task.goal || 0;
          goalSpan.textContent = dict.taskGoalLabel + goal + dict.taskGoalUnit;
          left.appendChild(nameSpan);
          left.appendChild(goalSpan);

          const right = document.createElement('button');
          right.className = 'text-red-500 text-[11px] px-2 py-1 rounded-full border border-red-200 bg-red-50 hover:bg-red-100 transition';
          right.textContent = 'âœ•';
          right.addEventListener('click', () => handleDeleteTask(task.id));

          wrapper.appendChild(left);
          wrapper.appendChild(right);
          taskListEl.appendChild(wrapper);
        });
      }

      function renderTodaySummary() {
        const dict = I18N[currentLang] || I18N.zh;
        if (!todaySummaryGridEl || !todayTotalBadgeEl) return;

        const todaySessions = getTodaySessions(sessions);
        const byTask = sumByTask(todaySessions);
        todaySummaryGridEl.innerHTML = '';

        let total = 0;

        tasks.forEach(task => {
          const minutes = byTask[task.id] || 0;
          total += minutes;
          const goal = task.goal || 0;
          const percent = goal > 0 ? Math.min(100, (minutes / goal) * 100) : 0;

          const card = document.createElement('div');
          card.className = 'border rounded-lg px-2.5 py-2 bg-slate-50';

          const titleRow = document.createElement('div');
          titleRow.className = 'flex items-center justify-between mb-1';
          const nameSpan = document.createElement('span');
          nameSpan.className = 'text-[11px] text-gray-600';
          nameSpan.textContent = getTaskDisplayName(task);
          const statusSpan = document.createElement('span');
          statusSpan.className = 'text-[10px] px-2 py-0.5 rounded-full border border-gray-200 text-gray-500 bg-white';
          if (goal > 0) {
            statusSpan.textContent = minutes >= goal ? 'âœ”ï¸' : 'â€¦';
          } else {
            statusSpan.textContent = 'â€“';
          }
          titleRow.appendChild(nameSpan);
          titleRow.appendChild(statusSpan);

          const valueRow = document.createElement('div');
          valueRow.className = 'flex items-baseline justify-between';
          const valueSpan = document.createElement('span');
          valueSpan.className = 'font-mono text-sm text-gray-800';
          valueSpan.textContent = `${minutes.toFixed(0)}${dict.todayTotalSuffix}`;
          const goalSpan = document.createElement('span');
          goalSpan.className = 'text-[10px] text-gray-400';
          if (goal > 0) {
            goalSpan.textContent = `${dict.taskGoalLabel}${goal}${dict.taskGoalUnit}`;
          } else {
            goalSpan.textContent = '';
          }
          valueRow.appendChild(valueSpan);
          valueRow.appendChild(goalSpan);

          card.appendChild(titleRow);
          card.appendChild(valueRow);

          if (goal > 0) {
            const bar = document.createElement('div');
            bar.className = 'mt-1 w-full h-1.5 rounded-full bg-slate-200 overflow-hidden';
            const fill = document.createElement('div');
            fill.className = 'h-1.5 bg-gradient-to-r from-sky-400 to-emerald-400';
            fill.style.width = `${percent}%`;
            bar.appendChild(fill);
            card.appendChild(bar);
          }

          todaySummaryGridEl.appendChild(card);
        });

        todayTotalBadgeEl.textContent =
          dict.todayTotalPrefix + total.toFixed(0) + dict.todayTotalSuffix;
      }

      function renderHistory() {
        const dict = I18N[currentLang] || I18N.zh;
        if (!historyBodyEl || !historyEmptyEl) return;
        historyBodyEl.innerHTML = '';

        if (sessions.length === 0) {
          historyEmptyEl.textContent = dict.historyEmpty;
          historyEmptyEl.classList.remove('hidden');
          return;
        }
        historyEmptyEl.classList.add('hidden');

        const sorted = [...sessions].sort(
          (a, b) => new Date(b.start) - new Date(a.start)
        );
        const recent = sorted.slice(0, 40);

        recent.forEach(s => {
          const tr = document.createElement('tr');
          const start = new Date(s.start);
          const end = s.end ? new Date(s.end) : null;
          const minutes = s.end ? computeDurationMinutes(s.start, s.end) : 0;
          const task = getTaskById(s.taskId);

          tr.innerHTML = `
          <td class="px-2 py-1 whitespace-nowrap">${formatDateYMD(start)}</td>
          <td class="px-2 py-1 whitespace-nowrap">${getTaskDisplayName(task)}</td>
          <td class="px-2 py-1 whitespace-nowrap">${formatTimeHM(start)}</td>
          <td class="px-2 py-1 whitespace-nowrap">${end ? formatTimeHM(end) : '-'}</td>
          <td class="px-2 py-1 text-right whitespace-nowrap">${minutes.toFixed(1)}</td>
        `;
          historyBodyEl.appendChild(tr);
        });
      }

      function renderWeeklyChart() {
        const canvas = document.getElementById('weeklyChart');
        if (!canvas || typeof Chart === 'undefined') return;
        const ctx = canvas.getContext('2d');

        const days = getLastNDaysDates(7);
        const totals = days.map(d => {
          const daySessions = sessions.filter(s =>
            isSameDate(new Date(s.start), d)
          );
          return sumTotalMinutes(daySessions);
        });
        const labels = days.map(d =>
          d.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' })
        );

        if (weeklyChart) {
          weeklyChart.data.labels = labels;
          weeklyChart.data.datasets[0].data = totals;
          weeklyChart.update();
          return;
        }

        weeklyChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'Total study time (minutes)',
                data: totals,
                borderWidth: 1,
                borderRadius: 6,
                backgroundColor: 'rgba(56, 189, 248, 0.55)',
                borderColor: 'rgba(56, 189, 248, 1)'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { grid: { display: false } },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(148, 163, 184, 0.3)' },
                ticks: { color: '#6b7280' }
              }
            },
            plugins: {
              legend: {
                labels: {
                  color: '#374151',
                  font: { size: 11 }
                }
              },
              tooltip: {
                callbacks: {
                  label: ctx => ` ${(ctx.parsed.y || 0).toFixed(1)} min`
                }
              }
            }
          }
        });
      }

      function renderAll() {
        renderTaskSelect();
        renderTaskList();
        renderTodaySummary();
        renderHistory();
        renderWeeklyChart();
        updateStatusUI();
      }

      function handleAddTask() {
        const nameZh = (newTaskNameZhEl.value || '').trim();
        const nameEn = (newTaskNameEnEl.value || '').trim();
        const nameKo = (newTaskNameKoEl.value || '').trim();
        const goalVal = parseInt(newTaskGoalEl.value, 10);

        if (!nameZh && !nameEn && !nameKo) {
          alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªè¯­è¨€çš„é¡¹ç›®åç§°');
          return;
        }
        if (!Number.isFinite(goalVal) || goalVal < 0) {
          alert('è¯·å¡«å†™åˆç†çš„æ¯æ—¥ç›®æ ‡åˆ†é’Ÿæ•°ï¼ˆ>= 0ï¼‰');
          return;
        }
        const baseName = nameEn || nameZh || nameKo;
        let id = slugify(baseName);
        if (tasks.some(t => t.id === id)) {
          id = `${id}_${Date.now()}`;
        }

        const newTask = {
          id,
          names: { zh: nameZh, en: nameEn, ko: nameKo },
          goal: goalVal
        };
        tasks.push(newTask);
        saveTasks();
        newTaskNameZhEl.value = '';
        newTaskNameEnEl.value = '';
        newTaskNameKoEl.value = '';
        newTaskGoalEl.value = '';

        renderAll();
      }

      function handleDeleteTask(taskId) {
        const ok = confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿå†å²è®°å½•ä¼šä¿ç•™ï¼Œä½†é¡¹ç›®åç§°å°†æ˜¾ç¤ºä¸ºã€Œå·²åˆ é™¤é¡¹ç›®ã€ã€‚');
        if (!ok) return;
        tasks = tasks.filter(t => t.id !== taskId);
        saveTasks();
        renderAll();
      }

      function handleStartOrPause() {
        if (currentSession) {
          handleStopCurrent();
          return;
        }
        if (!taskSelectEl) return;
        const taskId = taskSelectEl.value;
        if (!taskId) return;

        const nowISO = new Date().toISOString();
        currentSession = { taskId, start: nowISO };
        saveCurrentSession(currentSession);
        startTimerLoop();
        updateStatusUI();
      }

      function handleStopCurrent() {
        if (!currentSession) return;
        const nowISO = new Date().toISOString();
        const duration = computeDurationMinutes(currentSession.start, nowISO);
        if (duration > 0.01) {
          sessions.push({
            id: String(Date.now()),
            taskId: currentSession.taskId,
            start: currentSession.start,
            end: nowISO
          });
          saveSessions();
        }
        clearCurrentSession();
        currentSession = null;
        stopTimerLoop();
        renderAll();
      }

      function handleClearAll() {
        const ok = window.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­¦ä¹ è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚');
        if (!ok) return;
        sessions = [];
        saveSessions();
        clearCurrentSession();
        currentSession = null;
        stopTimerLoop();
        renderAll();
      }

      function makeSessionKey(s) {
        return `${s.taskId}|${s.start}|${s.end || ''}`;
      }

      async function syncWithCloud() {
        const dict = I18N[currentLang] || I18N.zh;
        if (!supabaseClient) {
          alert('Supabase æœªåˆå§‹åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦æ­£ç¡®å¼•å…¥ supabase-jsã€‚');
          return;
        }
        if (!currentAccountId) {
          alert(dict.syncNeedId);
          return;
        }

        const oldText = syncButtonEl ? syncButtonEl.textContent : '';
        const oldDisabled = syncButtonEl ? syncButtonEl.disabled : false;
        if (syncButtonEl) {
          syncButtonEl.disabled = true;
          syncButtonEl.textContent = 'â€¦';
        }
        if (statusTextEl) {
          statusTextEl.textContent = dict.syncWorking;
        }

        try {
          const { data, error } = await supabaseClient
            .from('study_sessions')
            .select('task_id, start_time, end_time')
            .eq('account_id', currentAccountId)
            .order('start_time', { ascending: true });

          if (error) throw error;

          const remoteSessions = (data || []).map(row => ({
            taskId: row.task_id,
            start: row.start_time,
            end: row.end_time
          }));

          const merged = [];
          const seen = new Set();

          remoteSessions.forEach(s => {
            const key = makeSessionKey(s);
            if (!seen.has(key)) {
              seen.add(key);
              merged.push({ ...s });
            }
          });

          sessions.forEach(s => {
            const key = makeSessionKey(s);
            if (!seen.has(key)) {
              seen.add(key);
              merged.push({ taskId: s.taskId, start: s.start, end: s.end });
            }
          });

          const remoteKeySet = new Set(remoteSessions.map(makeSessionKey));
          const rowsToInsert = merged
            .filter(s => !remoteKeySet.has(makeSessionKey(s)))
            .map(s => ({
              account_id: currentAccountId,
              task_id: s.taskId,
              start_time: s.start,
              end_time: s.end
            }));

          if (rowsToInsert.length > 0) {
            const { error: insertError } = await supabaseClient
              .from('study_sessions')
              .insert(rowsToInsert);
            if (insertError) throw insertError;
          }

          sessions = merged.map((s, index) => ({
            id: `${index}_${s.taskId}_${s.start}`,
            taskId: s.taskId,
            start: s.start,
            end: s.end
          }));
          saveSessions();
          renderAll();

          alert(dict.syncDone);
        } catch (e) {
          console.error(e);
          alert(dict.syncError + (e.message || e.toString()));
        } finally {
          if (syncButtonEl) {
            syncButtonEl.disabled = oldDisabled;
            syncButtonEl.textContent = oldText || 'â˜ï¸ åŒæ­¥';
          }
          updateStatusUI();
        }
      }

      function handleSyncClick() {
        if (accountIdInputEl) {
          setCurrentAccountId(accountIdInputEl.value);
        }
        syncWithCloud();
      }

      loadTasks();
      sessions = loadSessions();
      currentSession = loadCurrentSession();

      if (currentSession) {
        startTimerLoop();
      } else if (timerDisplayEl) {
        timerDisplayEl.textContent = '00:00:00';
      }

      if (toggleButtonEl) toggleButtonEl.addEventListener('click', handleStartOrPause);
      if (stopButtonEl) stopButtonEl.addEventListener('click', handleStopCurrent);
      if (clearAllButtonEl) clearAllButtonEl.addEventListener('click', handleClearAll);
      if (addTaskButtonEl) addTaskButtonEl.addEventListener('click', handleAddTask);
      if (syncButtonEl) syncButtonEl.addEventListener('click', handleSyncClick);

      langButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const lang = btn.getAttribute('data-lang');
          if (!lang) return;
          currentLang = lang;
          applyLang();
        });
      });

      renderAll();
      applyLang();
    });
  </script>

</body>
</html>
