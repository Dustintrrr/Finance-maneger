<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多币种财务管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Roboto, sans-serif; }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6">
        
        <!-- 头部：标题 + 汇率 + 语言 & 展示货币 + Tab -->
        <header class="flex justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fa-solid fa-wallet mr-2"></i>{{ t('appTitle') }}
                </h1>
                <p class="text-sm text-gray-500 mt-1">
                    <span v-if="usdToDisplay">
                        {{ t('todayRate') }}: 1 USD ≈ {{ usdToDisplay.toFixed(2) }} {{ displayCurrency }}
                    </span>
                    <span v-else>{{ t('fetchingRate') }}</span>
                </p>
            </div>

            <div class="flex flex-col items-end gap-2">
                <!-- Tab 切换 -->
                <div class="flex bg-white rounded-lg p-1 shadow-sm">
                    <button
                        @click="currentTab = 'subs'"
                        :class="{
                            'bg-indigo-600 text-white': currentTab === 'subs',
                            'text-gray-600': currentTab !== 'subs'
                        }"
                        class="px-4 py-2 rounded-md text-sm font-medium transition"
                    >
                        {{ t('tabSubs') }}
                    </button>
                    <button
                        @click="currentTab = 'debt'"
                        :class="{
                            'bg-red-600 text-white': currentTab === 'debt',
                            'text-gray-600': currentTab !== 'debt'
                        }"
                        class="px-4 py-2 rounded-md text-sm font-medium transition"
                    >
                        {{ t('tabDebt') }}
                    </button>
                </div>

                <!-- 语言 & 展示货币 -->
                <div class="flex gap-2">
                    <div class="bg-white rounded-lg shadow-sm px-2 py-1 flex items-center">
                        <span class="text-xs text-gray-500 mr-1">{{ t('languageLabel') }}:</span>
                        <select v-model="language" class="text-xs bg-transparent focus:outline-none">
                            <option value="zh">中文</option>
                            <option value="en">English</option>
                            <option value="ko">한국어</option>
                            <option value="es">Español</option>
                        </select>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm px-2 py-1 flex items-center">
                        <span class="text-xs text-gray-500 mr-1">{{ t('displayCurrency') }}:</span>
                        <select v-model="displayCurrency" class="text-xs bg-transparent focus:outline-none">
                            <option value="CNY">CNY</option>
                            <option value="USD">USD</option>
                            <option value="KRW">KRW</option>
                            <option value="EUR">EUR</option>
                            <option value="JPY">JPY</option>
                            <option value="HKD">HKD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <!-- 顶部统计卡片 -->
        <!-- 订阅/固定支出：3 张卡片 -->
        <section v-if="currentTab === 'subs'" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500 card">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                    {{ t('dailyAvg') }} ({{ displayCurrency }})
                </p>
                <p class="text-3xl font-bold mt-2 text-gray-800">
                    {{ currencySymbol }} {{ formatMoney(calculateTotal('day'), 2) }}
                </p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500 card">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                    {{ t('monthlyFixed') }} ({{ displayCurrency }})
                </p>
                <p class="text-3xl font-bold mt-2 text-gray-800">
                    {{ currencySymbol }} {{ formatMoney(calculateTotal('month'), 2) }}
                </p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500 card">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                    {{ t('annualTotal') }} ({{ displayCurrency }})
                </p>
                <p class="text-3xl font-bold mt-2 text-gray-800">
                    {{ currencySymbol }} {{ formatMoney(calculateTotal('year'), 0) }}
                </p>
            </div>
        </section>

        <!-- 债务：新增“债务总额”卡片 -->
        <section v-else class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500 card">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                    {{ t('debtTotal') }} ({{ displayCurrency }})
                </p>
                <p class="text-3xl font-bold mt-2 text-gray-800">
                    {{ currencySymbol }} {{ formatMoney(calculateDebtPrincipalTotal(), 0) }}
                </p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500 card">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                    {{ t('dailyAvg') }} ({{ displayCurrency }})
                </p>
                <p class="text-3xl font-bold mt-2 text-gray-800">
                    {{ currencySymbol }} {{ formatMoney(calculateTotal('day'), 2) }}
                </p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500 card">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                    {{ t('monthlyFixed') }} ({{ displayCurrency }})
                </p>
                <p class="text-3xl font-bold mt-2 text-gray-800">
                    {{ currencySymbol }} {{ formatMoney(calculateTotal('month'), 2) }}
                </p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500 card">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                    {{ t('annualTotal') }} ({{ displayCurrency }})
                </p>
                <p class="text-3xl font-bold mt-2 text-gray-800">
                    {{ currencySymbol }} {{ formatMoney(calculateTotal('year'), 0) }}
                </p>
            </div>
        </section>

        <!-- 月收入 & 结余 / 压力比 -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-700">
                <i class="fa-solid fa-scale-balanced mr-2"></i>{{ t('incomeTitle') }}
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
                <!-- 输入区 -->
                <div class="md:col-span-1">
                    <label class="block text-xs text-gray-500 mb-1">
                        {{ t('incomeInputLabel') }}
                    </label>
                    <div class="flex gap-2">
                        <input
                            v-model.number="income.amount"
                            type="number"
                            :placeholder="t('incomePlaceholder')"
                            class="border rounded px-3 py-2 text-sm flex-1 focus:ring-2 focus:outline-none focus:ring-emerald-200"
                        >
                        <select v-model="income.currency" class="border rounded px-2 py-2 text-sm bg-white">
                            <option value="CNY">CNY</option>
                            <option value="USD">USD</option>
                            <option value="KRW">KRW</option>
                            <option value="EUR">EUR</option>
                            <option value="JPY">JPY</option>
                            <option value="HKD">HKD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                    <p class="mt-1 text-xs text-gray-400">
                        {{ t('incomeHint') }}
                    </p>
                </div>

                <!-- 月收入 & 月总支出 -->
                <div class="bg-slate-50 rounded-lg p-3 flex flex-col justify-between">
                    <div>
                        <p class="text-xs text-gray-500">
                            {{ t('incomeCardIncome') }} ({{ displayCurrency }})
                        </p>
                        <p class="text-lg font-semibold text-gray-800 mt-1">
                            {{ currencySymbol }} {{ formatMoney(monthlyIncomeDisplay, 2) }}
                        </p>
                        <p
                            v-if="income.amount"
                            class="text-xs text-gray-400 mt-1"
                        >
                            ({{ income.currency }} {{ formatMoney(income.amount, 0) }})
                        </p>
                    </div>
                    <div class="mt-3">
                        <p class="text-xs text-gray-500">
                            {{ t('incomeCardOutflow') }} ({{ displayCurrency }})
                        </p>
                        <p class="text-sm font-medium text-gray-800 mt-1">
                            {{ currencySymbol }} {{ formatMoney(totalMonthlyAll, 2) }}
                        </p>
                    </div>
                </div>

                <!-- 结余 & 压力比 -->
                <div class="bg-slate-50 rounded-lg p-3 flex flex-col justify-between">
                    <div>
                        <p class="text-xs text-gray-500">
                            {{ t('incomeCardSurplus') }} ({{ displayCurrency }})
                        </p>
                        <p
                            class="text-lg font-semibold mt-1"
                            :class="surplusDisplay >= 0 ? 'text-emerald-600' : 'text-red-600'"
                        >
                            {{ currencySymbol }} {{ formatMoney(surplusDisplay, 2) }}
                        </p>
                    </div>
                    <div class="mt-3">
                        <p class="text-xs text-gray-500">
                            {{ t('incomeCardRatio') }}
                        </p>
                        <p class="text-sm font-medium text-gray-800 mt-1">
                            {{ stressRatioDisplay }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加项目区域 -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-700">
                <i class="fa-solid fa-plus-circle mr-2"></i>
                {{ currentTab === 'subs' ? t('addSubsTitle') : t('addDebtTitle') }}
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-6 gap-3">
                <!-- 名称 -->
                <input
                    v-model="newItem.name"
                    :placeholder="t('namePlaceholder')"
                    class="border rounded px-3 py-2 text-sm focus:ring-2 focus:outline-none md:col-span-2"
                    :class="currentTab === 'subs' ? 'focus:ring-indigo-200' : 'focus:ring-red-200'"
                >

                <!-- 金额（每月/每年 或 每期还款） -->
                <div class="relative">
                    <span class="absolute left-3 top-2 text-gray-400 text-sm">$</span>
                    <input
                        v-model.number="newItem.amount"
                        type="number"
                        :placeholder="currentTab === 'subs' ? t('amountPlaceholderSubs') : t('amountPlaceholderDebt')"
                        class="border rounded pl-6 pr-3 py-2 text-sm w-full focus:ring-2 focus:outline-none"
                        :class="currentTab === 'subs' ? 'focus:ring-indigo-200' : 'focus:ring-red-200'"
                    >
                </div>

                <!-- 债务总额（仅在债务页显示，可选） -->
                <div class="relative" v-if="currentTab === 'debt'">
                    <span class="absolute left-3 top-2 text-gray-400 text-sm">$</span>
                    <input
                        v-model.number="newItem.totalDebt"
                        type="number"
                        :placeholder="t('totalDebtPlaceholder')"
                        class="border rounded pl-6 pr-3 py-2 text-sm w-full focus:ring-2 focus:outline-none"
                        :class="'focus:ring-red-200'"
                    >
                </div>

                <!-- 币种 -->
                <select v-model="newItem.currency" class="border rounded px-2 py-2 text-sm bg-white">
                    <option value="CNY">CNY (人民币)</option>
                    <option value="USD">USD (US Dollar)</option>
                    <option value="KRW">KRW (₩ 한국 원)</option>
                    <option value="EUR">EUR (Euro)</option>
                    <option value="JPY">JPY (日元)</option>
                    <option value="HKD">HKD (港币)</option>
                    <option value="GBP">GBP (Pound)</option>
                </select>

                <!-- 周期 -->
                <select v-model="newItem.period" class="border rounded px-2 py-2 text-sm bg-white">
                    <option value="month">{{ t('month') }}</option>
                    <option value="year">{{ t('year') }}</option>
                </select>

                <!-- 分类 -->
                <select v-model="newItem.category" class="border rounded px-2 py-2 text-sm bg-white">
                    <option
                        v-for="opt in categoryOptions"
                        :key="opt.value"
                        :value="opt.value"
                    >
                        {{ t('cat_' + opt.value) }}
                    </option>
                </select>
            </div>

            <button
                @click="addItem"
                class="mt-4 w-full text-white font-bold py-2 px-4 rounded transition duration-200"
                :class="currentTab === 'subs' ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-red-600 hover:bg-red-700'"
            >
                {{ t('addButton') }}
            </button>
        </div>

        <!-- 列表区域 -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-semibold text-gray-700">{{ t('detailList') }}</h3>
                <span class="text-xs text-gray-500">{{ t('autoConvertNote') }}</span>
            </div>

            <!-- 搜索 & 排序 -->
            <div
                v-if="currentList.length > 0"
                class="px-6 py-3 border-b border-gray-100 bg-white flex flex-col md:flex-row md:items-center md:justify-between gap-3"
            >
                <div class="flex items-center gap-2 w-full md:w-1/2">
                    <i class="fa-solid fa-magnifying-glass text-gray-400 text-sm"></i>
                    <input
                        v-model="searchQuery"
                        :placeholder="t('searchPlaceholder')"
                        class="flex-1 border rounded px-3 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-indigo-100"
                    >
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">{{ t('sortLabel') }}:</span>
                    <select
                        v-model="sortKey"
                        class="border rounded px-2 py-1.5 text-xs bg-white"
                    >
                        <option value="monthlyDesc">{{ t('sortMonthlyDesc') }}</option>
                        <option value="nameAsc">{{ t('sortNameAsc') }}</option>
                        <option value="nameDesc">{{ t('sortNameDesc') }}</option>
                    </select>
                </div>
            </div>

            <!-- 分类汇总 -->
            <div
                v-if="currentList.length > 0 && Object.keys(categoryTotals).length"
                class="px-6 py-3 border-b border-gray-100 bg-slate-50 text-xs text-gray-600 flex flex-wrap gap-3"
            >
                <span class="font-semibold text-gray-700">
                    {{ t('categorySummary') }}:
                </span>
                <span
                    v-for="(val, catKey) in categoryTotals"
                    :key="catKey"
                    class="inline-flex items-center gap-1"
                >
                    <span class="px-2 py-0.5 rounded-full text-[11px] font-medium bg-white border border-gray-200">
                        {{ t('cat_' + catKey) }}
                    </span>
                    <span>
                        {{ currencySymbol }} {{ formatMoney(val, 1) }}/{{ t('perMonthShort') }}
                    </span>
                </span>
            </div>
            
            <div v-if="currentList.length === 0" class="p-8 text-center text-gray-400">
                {{ currentTab === 'subs' ? t('noDataSubs') : t('noDataDebt') }}
            </div>

            <ul v-else class="divide-y divide-gray-100">
                <li
                    v-for="item in displayList"
                    :key="item.id || item.name + '_' + item.currency + '_' + item.period + '_' + item.amount"
                    :class="[
                        'p-4 hover:bg-gray-50 flex justify-between items-center group',
                        item.enabled ? '' : 'opacity-60'
                    ]"
                >
                    <div class="flex items-center">
                        <div
                            class="w-10 h-10 rounded-full flex items-center justify-center mr-4"
                            :class="currentTab === 'subs' ? 'bg-indigo-100 text-indigo-600' : 'bg-red-100 text-red-600'"
                        >
                            <i class="fa-solid" :class="item.period === 'year' ? 'fa-calendar' : 'fa-calendar-day'"></i>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <p class="font-medium text-gray-800">{{ item.name }}</p>
                                <span
                                    class="px-2 py-0.5 rounded-full text-[11px] font-medium bg-slate-100 text-slate-700"
                                >
                                    {{ t('cat_' + (item.category || 'other')) }}
                                </span>
                            </div>
                            <p class="text-xs text-gray-500">
                                {{ t('originalPrice') }}:
                                {{ item.currency }} {{ item.amount }}
                                / {{ item.period === 'year' ? t('yearShort') : t('monthShort') }}
                            </p>
                            <!-- 债务条目显示总额（如有） -->
                            <p
                                v-if="currentTab === 'debt' && item.totalDebt"
                                class="text-xs text-gray-500 mt-1"
                            >
                                {{ t('debtTotal') }}:
                                {{ item.currency }} {{ item.totalDebt }}
                                (≈ {{ currencySymbol }} {{ formatMoney(convertDebtTotal(item), 0) }})
                            </p>
                        </div>
                    </div>
                    
                    <div class="text-right flex items-center gap-4">
                        <div class="flex flex-col items-end gap-1">
                            <div>
                                <p class="font-bold text-gray-700">
                                    {{ currencySymbol }} {{ formatMoney(convertToMonthly(item), 1) }}
                                </p>
                                <p class="text-xs text-gray-400">{{ t('perMonth') }}</p>
                            </div>
                            <label class="flex items-center gap-1 text-[11px] text-gray-500 cursor-pointer">
                                <input
                                    type="checkbox"
                                    v-model="item.enabled"
                                    class="h-3 w-3 rounded border-gray-300"
                                >
                                <span>{{ t('includeInCalc') }}</span>
                            </label>
                        </div>
                        <button
                            @click="deleteItem(item)"
                            class="text-gray-300 hover:text-red-500 transition p-2"
                        >
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </li>
            </ul>
        </div>

        <!-- 备份 / 导入 -->
        <div class="bg-white rounded-xl shadow-sm p-6 mt-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-700">
                <i class="fa-solid fa-cloud-arrow-up mr-2"></i>{{ t('backupTitle') }}
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 导出 -->
                <div>
                    <p class="text-xs text-gray-500 mb-2">{{ t('exportDesc') }}</p>
                    <button
                        @click="exportData"
                        class="mb-2 px-3 py-1 text-xs font-semibold rounded bg-slate-800 text-white hover:bg-slate-900"
                    >
                        {{ t('exportButton') }}
                    </button>
                    <textarea
                        v-model="exportText"
                        class="w-full h-32 border rounded px-2 py-1 text-xs font-mono resize-y"
                        readonly
                    ></textarea>
                </div>

                <!-- 导入 -->
                <div>
                    <p class="text-xs text-gray-500 mb-2">{{ t('importDesc') }}</p>
                    <textarea
                        v-model="importText"
                        :placeholder="t('importPlaceholder')"
                        class="w-full h-32 border rounded px-2 py-1 text-xs font-mono resize-y"
                    ></textarea>
                    <button
                        @click="importData"
                        class="mt-2 px-3 py-1 text-xs font-semibold rounded bg-emerald-600 text-white hover:bg-emerald-700"
                    >
                        {{ t('importButton') }}
                    </button>
                </div>
            </div>
        </div>
        
        <div class="mt-8 text-center text-xs text-gray-400 space-y-1">
            <p>{{ t('localNote') }}</p>
            <p>{{ t('rateSource') }}</p>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const currentTab = ref('subs'); // subs or debt
                const language = ref('zh');     // zh / en / ko / es
                const displayCurrency = ref('CNY'); // 展示货币
                const rates = ref({});

                const subscriptions = ref([]);
                const debts = ref([]);

                const newItem = ref({
                    name: '',
                    amount: '',
                    totalDebt: '',
                    currency: 'USD',
                    period: 'month',
                    category: 'essential'
                });

                // 分类选项
                const categoryOptions = [
                    { value: 'essential' },
                    { value: 'housing' },
                    { value: 'transport' },
                    { value: 'entertainment' },
                    { value: 'tools' },
                    { value: 'education' },
                    { value: 'other' }
                ];

                // 月收入
                const income = ref({
                    amount: '',
                    currency: 'CNY'
                });

                // 搜索 & 排序
                const searchQuery = ref('');
                const sortKey = ref('monthlyDesc');

                // 备份文本
                const exportText = ref('');
                const importText = ref('');

                // 多语言文案
                const messages = {
                    zh: {
                        appTitle: '财务管理中心',
                        todayRate: '今日汇率',
                        fetchingRate: '正在获取实时汇率...',
                        tabSubs: '订阅/固定支出',
                        tabDebt: '债务/负面页',
                        dailyAvg: '每日均摊',
                        monthlyFixed: '每月固定',
                        annualTotal: '年度总成本',
                        debtTotal: '债务总额',
                        addSubsTitle: '添加订阅项目',
                        addDebtTitle: '添加债务',
                        namePlaceholder: '项目名称',
                        amountPlaceholderSubs: '金额',
                        amountPlaceholderDebt: '每期还款金额',
                        totalDebtPlaceholder: '债务总额 (可选)',
                        currencyLabel: '币种',
                        periodLabel: '周期',
                        month: '每月付',
                        year: '每年付',
                        addButton: '确认添加',
                        detailList: '详细清单',
                        autoConvertNote: '自动换算为展示货币',
                        noDataSubs: '暂无数据，请添加您的第一笔订阅。',
                        noDataDebt: '暂无数据，请添加您的第一笔债务。',
                        originalPrice: '原价',
                        perMonth: '/ 月',
                        perYear: '/ 年',
                        localNote: '数据存储在您的本地浏览器中，清除缓存可能会导致数据丢失。',
                        rateSource: '汇率数据来源: ExchangeRate-API',
                        displayCurrency: '展示货币',
                        languageLabel: '语言',
                        monthShort: '月',
                        yearShort: '年',
                        fillAll: '请填写完整信息',
                        backupTitle: '数据备份 / 迁移',
                        exportDesc: '点击生成一段文本，复制保存，换设备时粘贴导入即可。',
                        exportButton: '生成备份',
                        importDesc: '在此粘贴之前导出的文本，然后点击“导入数据”。',
                        importPlaceholder: '在此粘贴备份 JSON 文本……',
                        importButton: '导入数据',
                        importSuccess: '导入成功！当前页面数据已被备份数据覆盖。',
                        importError: '导入失败：JSON 格式不正确或缺少关键字段。',
                        incomeTitle: '月收入 & 结余',
                        incomeInputLabel: '月收入（税后）',
                        incomePlaceholder: '请输入你的月收入',
                        incomeHint: '建议填写税后稳定收入，用于估算结余与压力。',
                        incomeCardIncome: '月收入',
                        incomeCardOutflow: '月总支出',
                        incomeCardSurplus: '月结余',
                        incomeCardRatio: '支出 / 收入比',
                        // 新增：分类 & 搜索 & 排序
                        categoryLabel: '分类',
                        categorySummary: '按分类汇总',
                        perMonthShort: '月',
                        includeInCalc: '参与计算',
                        searchPlaceholder: '搜索项目名称...',
                        sortLabel: '排序',
                        sortMonthlyDesc: '按月费用从高到低',
                        sortNameAsc: '按名称 A→Z',
                        sortNameDesc: '按名称 Z→A',
                        cat_essential: '刚需',
                        cat_housing: '住房',
                        cat_transport: '交通',
                        cat_entertainment: '娱乐',
                        cat_tools: '工具',
                        cat_education: '教育',
                        cat_other: '其他'
                    },
                    en: {
                        appTitle: 'Finance Control Center',
                        todayRate: "Today's rate",
                        fetchingRate: 'Fetching live rates...',
                        tabSubs: 'Subscriptions / Fixed costs',
                        tabDebt: 'Debts / Negative page',
                        dailyAvg: 'Daily average',
                        monthlyFixed: 'Monthly fixed',
                        annualTotal: 'Yearly total',
                        debtTotal: 'Total debt',
                        addSubsTitle: 'Add subscription item',
                        addDebtTitle: 'Add debt',
                        namePlaceholder: 'Item name',
                        amountPlaceholderSubs: 'Amount',
                        amountPlaceholderDebt: 'Installment amount',
                        totalDebtPlaceholder: 'Total debt (optional)',
                        currencyLabel: 'Currency',
                        periodLabel: 'Period',
                        month: 'Pay monthly',
                        year: 'Pay yearly',
                        addButton: 'Add',
                        detailList: 'Detail list',
                        autoConvertNote: 'Converted to display currency automatically',
                        noDataSubs: 'No data yet. Add your first subscription.',
                        noDataDebt: 'No data yet. Add your first debt.',
                        originalPrice: 'Original',
                        perMonth: '/ month',
                        perYear: '/ year',
                        localNote: 'Data is stored in your local browser. Clearing cache may erase it.',
                        rateSource: 'Exchange rate source: ExchangeRate-API',
                        displayCurrency: 'Display currency',
                        languageLabel: 'Language',
                        monthShort: 'month',
                        yearShort: 'year',
                        fillAll: 'Please fill in all required fields',
                        backupTitle: 'Data backup / migration',
                        exportDesc: 'Click to generate a text backup. Copy & save it, paste it on another device to restore.',
                        exportButton: 'Generate backup',
                        importDesc: 'Paste your previously exported text here, then click "Import data".',
                        importPlaceholder: 'Paste backup JSON text here…',
                        importButton: 'Import data',
                        importSuccess: 'Import succeeded! Current data has been replaced by backup.',
                        importError: 'Import failed: invalid JSON or missing fields.',
                        incomeTitle: 'Monthly income & balance',
                        incomeInputLabel: 'Monthly income (after tax)',
                        incomePlaceholder: 'Enter your monthly income',
                        incomeHint: 'Use your stable after-tax income to estimate surplus & pressure.',
                        incomeCardIncome: 'Monthly income',
                        incomeCardOutflow: 'Total monthly spending',
                        incomeCardSurplus: 'Monthly surplus',
                        incomeCardRatio: 'Spending / income ratio',
                        categoryLabel: 'Category',
                        categorySummary: 'By category',
                        perMonthShort: 'mo',
                        includeInCalc: 'Include in totals',
                        searchPlaceholder: 'Search by name...',
                        sortLabel: 'Sort',
                        sortMonthlyDesc: 'By monthly cost (high → low)',
                        sortNameAsc: 'By name A → Z',
                        sortNameDesc: 'By name Z → A',
                        cat_essential: 'Essential',
                        cat_housing: 'Housing',
                        cat_transport: 'Transport',
                        cat_entertainment: 'Entertainment',
                        cat_tools: 'Tools',
                        cat_education: 'Education',
                        cat_other: 'Other'
                    },
                    ko: {
                        appTitle: '재무 관리 센터',
                        todayRate: '오늘 환율',
                        fetchingRate: '실시간 환율 불러오는 중...',
                        tabSubs: '구독 / 고정지출',
                        tabDebt: '부채 / 마이너스',
                        dailyAvg: '일 평균',
                        monthlyFixed: '월 고정',
                        annualTotal: '연간 총액',
                        debtTotal: '부채 총액',
                        addSubsTitle: '구독 항목 추가',
                        addDebtTitle: '부채 추가',
                        namePlaceholder: '항목 이름',
                        amountPlaceholderSubs: '금액',
                        amountPlaceholderDebt: '매 회 상환 금액',
                        totalDebtPlaceholder: '부채 총액 (선택 사항)',
                        currencyLabel: '통화',
                        periodLabel: '주기',
                        month: '매월 결제',
                        year: '매년 결제',
                        addButton: '추가',
                        detailList: '상세 목록',
                        autoConvertNote: '표시 통화로 자동 환산',
                        noDataSubs: '아직 데이터가 없습니다. 첫 구독을 추가하세요.',
                        noDataDebt: '아직 데이터가 없습니다. 첫 부채를 추가하세요.',
                        originalPrice: '원가',
                        perMonth: '/ 월',
                        perYear: '/ 년',
                        localNote: '데이터는 이 브라우저에만 저장됩니다. 캐시를 지우면 삭제될 수 있습니다.',
                        rateSource: '환율 데이터: ExchangeRate-API',
                        displayCurrency: '표시 통화',
                        languageLabel: '언어',
                        monthShort: '개월',
                        yearShort: '년',
                        fillAll: '필수 항목을 모두 입력해주세요.',
                        backupTitle: '데이터 백업 / 이전',
                        exportDesc: '버튼을 눌러 백업 텍스트를 생성하고 저장한 뒤, 다른 기기에서 붙여넣어 복원할 수 있습니다.',
                        exportButton: '백업 생성',
                        importDesc: '이전에 내보낸 텍스트를 여기에 붙여넣고 "데이터 가져오기"를 클릭하세요.',
                        importPlaceholder: '백업 JSON 텍스트를 여기에 붙여넣기…',
                        importButton: '데이터 가져오기',
                        importSuccess: '가져오기 완료! 현재 데이터가 백업 데이터로 교체되었습니다.',
                        importError: '가져오기 실패: JSON 형식이 잘못되었거나 필드가 부족합니다.',
                        incomeTitle: '월 소득 & 잉여',
                        incomeInputLabel: '월 소득 (세후)',
                        incomePlaceholder: '월 소득을 입력하세요',
                        incomeHint: '세후 기준의 안정적인 소득을 입력하면 잉여와 부담 비율을 볼 수 있습니다.',
                        incomeCardIncome: '월 소득',
                        incomeCardOutflow: '월 총지출',
                        incomeCardSurplus: '월 잉여',
                        incomeCardRatio: '지출 / 소득 비율',
                        categoryLabel: '분류',
                        categorySummary: '분류별 합계',
                        perMonthShort: '월',
                        includeInCalc: '계산에 포함',
                        searchPlaceholder: '이름으로 검색...',
                        sortLabel: '정렬',
                        sortMonthlyDesc: '월 비용 높은 순',
                        sortNameAsc: '이름 A → Z',
                        sortNameDesc: '이름 Z → A',
                        cat_essential: '필수',
                        cat_housing: '주거',
                        cat_transport: '교통',
                        cat_entertainment: '엔터테인먼트',
                        cat_tools: '도구',
                        cat_education: '교육',
                        cat_other: '기타'
                    },
                    es: {
                        appTitle: 'Centro de gestión financiera',
                        todayRate: 'Tipo de cambio de hoy',
                        fetchingRate: 'Cargando tipos de cambio...',
                        tabSubs: 'Suscripciones / Gastos fijos',
                        tabDebt: 'Deudas / Página negativa',
                        dailyAvg: 'Promedio diario',
                        monthlyFixed: 'Fijo mensual',
                        annualTotal: 'Total anual',
                        debtTotal: 'Deuda total',
                        addSubsTitle: 'Añadir suscripción',
                        addDebtTitle: 'Añadir deuda',
                        namePlaceholder: 'Nombre del ítem',
                        amountPlaceholderSubs: 'Importe',
                        amountPlaceholderDebt: 'Cuota de pago',
                        totalDebtPlaceholder: 'Deuda total (opcional)',
                        currencyLabel: 'Moneda',
                        periodLabel: 'Período',
                        month: 'Pago mensual',
                        year: 'Pago anual',
                        addButton: 'Añadir',
                        detailList: 'Lista detallada',
                        autoConvertNote: 'Convertido automáticamente a la moneda de visualización',
                        noDataSubs: 'No hay datos. Añade tu primera suscripción.',
                        noDataDebt: 'No hay datos. Añade tu primera deuda.',
                        originalPrice: 'Original',
                        perMonth: '/ mes',
                        perYear: '/ año',
                        localNote: 'Los datos se guardan en tu navegador. Borrar la caché puede eliminarlos.',
                        rateSource: 'Fuente de tipos de cambio: ExchangeRate-API',
                        displayCurrency: 'Moneda de visualización',
                        languageLabel: 'Idioma',
                        monthShort: 'mes',
                        yearShort: 'año',
                        fillAll: 'Rellena todos los campos requeridos, por favor.',
                        backupTitle: 'Copia de seguridad / migración de datos',
                        exportDesc: 'Haz clic para generar un texto de copia de seguridad. Guárdalo y pégalo en otro dispositivo para restaurar.',
                        exportButton: 'Generar copia',
                        importDesc: 'Pega aquí el texto exportado anteriormente y haz clic en "Importar datos".',
                        importPlaceholder: 'Pega aquí el texto JSON de la copia…',
                        importButton: 'Importar datos',
                        importSuccess: '¡Importación completada! Los datos actuales han sido reemplazados por la copia.',
                        importError: 'Error al importar: JSON no válido o campos faltantes.',
                        incomeTitle: 'Ingreso mensual y saldo',
                        incomeInputLabel: 'Ingreso mensual (neto)',
                        incomePlaceholder: 'Introduce tu ingreso mensual',
                        incomeHint: 'Usa tu ingreso neto y estable para estimar el saldo y la presión.',
                        incomeCardIncome: 'Ingreso mensual',
                        incomeCardOutflow: 'Gasto mensual total',
                        incomeCardSurplus: 'Superávit mensual',
                        incomeCardRatio: 'Relación gasto / ingreso',
                        categoryLabel: 'Categoría',
                        categorySummary: 'Por categoría',
                        perMonthShort: 'mes',
                        includeInCalc: 'Incluir en totales',
                        searchPlaceholder: 'Buscar por nombre...',
                        sortLabel: 'Ordenar',
                        sortMonthlyDesc: 'Por coste mensual (alto → bajo)',
                        sortNameAsc: 'Por nombre A → Z',
                        sortNameDesc: 'Por nombre Z → A',
                        cat_essential: 'Esencial',
                        cat_housing: 'Vivienda',
                        cat_transport: 'Transporte',
                        cat_entertainment: 'Entretenimiento',
                        cat_tools: 'Herramientas',
                        cat_education: 'Educación',
                        cat_other: 'Otros'
                    }
                };

                const t = (key) => {
                    const pack = messages[language.value] || messages.zh;
                    return pack[key] || key;
                };

                const currencySymbols = {
                    CNY: '¥',
                    USD: '$',
                    EUR: '€',
                    JPY: '¥',
                    KRW: '₩',
                    HKD: '$',
                    GBP: '£'
                };

                const currencySymbol = computed(() => currencySymbols[displayCurrency.value] || '');

                // 归一化：为旧数据补上 enabled / category
                const normalizeList = (list) => {
                    if (!Array.isArray(list)) return [];
                    return list.map(item => ({
                        enabled: true,
                        category: 'other',
                        ...item
                    }));
                };

                // 汇率：以 CNY 为基准，然后构造「1 单位外币 = ? CNY」
                const fetchRates = async () => {
                    try {
                        const res = await fetch('https://api.exchangerate-api.com/v4/latest/CNY');
                        const data = await res.json();

                        const cnyBasedRates = {};
                        for (const [key, value] of Object.entries(data.rates)) {
                            // data.rates[key] = 1 CNY = value [key]
                            // 所以 1 [key] = 1 / value CNY
                            cnyBasedRates[key] = 1 / value;
                        }
                        cnyBasedRates['CNY'] = 1;
                        rates.value = cnyBasedRates;
                    } catch (e) {
                        console.error("汇率获取失败，使用默认值", e);
                        // 默认：1 单位 = ? CNY
                        rates.value = {
                            USD: 7.2,
                            CNY: 1,
                            EUR: 7.8,
                            JPY: 0.048,
                            HKD: 0.92,
                            GBP: 9.1,
                            KRW: 0.0053 // 大约 1 韩元 ≈ 0.0053 人民币
                        };
                    }
                };

                // 通用换算函数：从 from 货币 转成 to 货币
                const convertCurrency = (amount, from, to) => {
                    if (!amount || !rates.value[from] || !rates.value[to]) return 0;
                    const inCNY = amount * rates.value[from]; // 先转成 CNY
                    return inCNY / rates.value[to];           // 再从 CNY 转成目标货币
                };

                // 将条目转为“展示货币下的月度成本”，只计算 enabled
                const convertToMonthly = (item) => {
                    if (!item.enabled) return 0;
                    if (!item.amount || !rates.value[item.currency]) return 0;
                    const amountNum = Number(item.amount) || 0;
                    let monthlyInItem = 0;

                    if (item.period === 'month') {
                        monthlyInItem = amountNum;
                    } else if (item.period === 'year') {
                        monthlyInItem = amountNum / 12;
                    }

                    return convertCurrency(monthlyInItem, item.currency, displayCurrency.value);
                };

                // 按列表计算月总支出
                const totalMonthlySubs = computed(() => {
                    return subscriptions.value.reduce((sum, item) => sum + convertToMonthly(item), 0);
                });

                const totalMonthlyDebts = computed(() => {
                    return debts.value.reduce((sum, item) => sum + convertToMonthly(item), 0);
                });

                const totalMonthlyAll = computed(() => {
                    return totalMonthlySubs.value + totalMonthlyDebts.value;
                });

                // 总额：以“展示货币”为单位（当前 Tab）
                const calculateTotal = (scale) => {
                    const list = currentTab.value === 'subs' ? subscriptions.value : debts.value;
                    let totalMonthly = 0;

                    for (const item of list) {
                        totalMonthly += convertToMonthly(item);
                    }

                    if (scale === 'month') return totalMonthly;
                    if (scale === 'year') return totalMonthly * 12;
                    if (scale === 'day') return totalMonthly / 30.44;
                    return 0;
                };

                // 债务本金合计（展示货币，只计算 enabled）
                const calculateDebtPrincipalTotal = () => {
                    let total = 0;
                    for (const item of debts.value) {
                        if (!item.enabled) continue;
                        if (!item.totalDebt || !rates.value[item.currency]) continue;
                        const principal = Number(item.totalDebt) || 0;
                        total += convertCurrency(principal, item.currency, displayCurrency.value);
                    }
                    return total;
                };

                // 单条债务本金换算（展示）
                const convertDebtTotal = (item) => {
                    if (!item.enabled) return 0;
                    if (!item.totalDebt || !rates.value[item.currency]) return 0;
                    const principal = Number(item.totalDebt) || 0;
                    return convertCurrency(principal, item.currency, displayCurrency.value);
                };

                // 顶部显示：1 USD 对当前展示货币
                const usdToDisplay = computed(() => {
                    if (!rates.value['USD'] || !rates.value[displayCurrency.value]) return null;
                    return convertCurrency(1, 'USD', displayCurrency.value);
                });

                // 月收入（展示货币）
                const monthlyIncomeDisplay = computed(() => {
                    if (!income.value.amount || !rates.value[income.value.currency]) return 0;
                    const amt = Number(income.value.amount) || 0;
                    return convertCurrency(amt, income.value.currency, displayCurrency.value);
                });

                // 月结余 & 压力比
                const surplusDisplay = computed(() => {
                    return monthlyIncomeDisplay.value - totalMonthlyAll.value;
                });

                const stressRatioDisplay = computed(() => {
                    if (!income.value.amount || monthlyIncomeDisplay.value <= 0) return '--';
                    const ratio = (totalMonthlyAll.value / monthlyIncomeDisplay.value) * 100;
                    return ratio.toFixed(1) + '%';
                });

                // 当前列表（原始数据）
                const currentList = computed(() => {
                    return currentTab.value === 'subs' ? subscriptions.value : debts.value;
                });

                // 分类汇总（当前 Tab，按月度成本）
                const categoryTotals = computed(() => {
                    const list = currentList.value;
                    const totals = {};
                    for (const item of list) {
                        const monthly = convertToMonthly(item);
                        if (!monthly) continue;
                        const cat = item.category || 'other';
                        totals[cat] = (totals[cat] || 0) + monthly;
                    }
                    return totals;
                });

                // 显示列表：带搜索 & 排序
                const displayList = computed(() => {
                    let list = currentList.value.slice();
                    const q = searchQuery.value.trim().toLowerCase();
                    if (q) {
                        list = list.filter(item =>
                            (item.name || '').toString().toLowerCase().includes(q)
                        );
                    }
                    list.sort((a, b) => {
                        if (sortKey.value === 'monthlyDesc') {
                            return convertToMonthly(b) - convertToMonthly(a);
                        } else if (sortKey.value === 'nameAsc') {
                            return (a.name || '').toString().localeCompare((b.name || '').toString());
                        } else if (sortKey.value === 'nameDesc') {
                            return (b.name || '').toString().localeCompare((a.name || '').toString());
                        }
                        return 0;
                    });
                    return list;
                });

                // 增加项目
                const addItem = () => {
                    if (!newItem.value.name || !newItem.value.amount) {
                        alert(t('fillAll'));
                        return;
                    }
                    const list = currentTab.value === 'subs' ? subscriptions.value : debts.value;

                    list.push({
                        id: Date.now() + '-' + Math.random().toString(16).slice(2),
                        name: newItem.value.name,
                        amount: newItem.value.amount,
                        totalDebt: currentTab.value === 'debt' ? newItem.value.totalDebt : '',
                        currency: newItem.value.currency,
                        period: newItem.value.period,
                        category: newItem.value.category || 'other',
                        enabled: true
                    });

                    // 重置表单（保留币种 & 分类方便连续输入）
                    newItem.value.name = '';
                    newItem.value.amount = '';
                    if (currentTab.value === 'debt') {
                        newItem.value.totalDebt = '';
                    }
                };

                const deleteItem = (itemToRemove) => {
                    const list = currentTab.value === 'subs' ? subscriptions.value : debts.value;
                    const idx = list.indexOf(itemToRemove);
                    if (idx !== -1) {
                        list.splice(idx, 1);
                    }
                };

                const formatMoney = (value, digits = 2) => {
                    const num = Number(value) || 0;
                    return num.toLocaleString(undefined, {
                        minimumFractionDigits: digits,
                        maximumFractionDigits: digits
                    });
                };

                // 导出数据
                const exportData = () => {
                    const payload = {
                        version: 3,
                        language: language.value,
                        displayCurrency: displayCurrency.value,
                        subscriptions: subscriptions.value,
                        debts: debts.value,
                        income: income.value
                    };
                    exportText.value = JSON.stringify(payload, null, 2);
                };

                // 导入数据
                const importData = () => {
                    if (!importText.value) {
                        alert(t('fillAll'));
                        return;
                    }
                    try {
                        const data = JSON.parse(importText.value);
                        if (!data || typeof data !== 'object') {
                            throw new Error('invalid payload');
                        }
                        if (Array.isArray(data.subscriptions)) {
                            subscriptions.value = normalizeList(data.subscriptions);
                        }
                        if (Array.isArray(data.debts)) {
                            debts.value = normalizeList(data.debts);
                        }
                        if (data.language) {
                            language.value = data.language;
                        }
                        if (data.displayCurrency) {
                            displayCurrency.value = data.displayCurrency;
                        }
                        if (data.income && typeof data.income === 'object') {
                            income.value = {
                                amount: data.income.amount || '',
                                currency: data.income.currency || 'CNY'
                            };
                        }
                        alert(t('importSuccess'));
                    } catch (e) {
                        console.error('Import error', e);
                        alert(t('importError'));
                    }
                };

                // 持久化
                onMounted(() => {
                    fetchRates();
                    const savedSubs = localStorage.getItem('my_finance_subs');
                    const savedDebts = localStorage.getItem('my_finance_debts');
                    const savedLang = localStorage.getItem('my_finance_lang');
                    const savedDisplayCurrency = localStorage.getItem('my_finance_display_currency');
                    const savedIncome = localStorage.getItem('my_finance_income');

                    if (savedSubs) {
                        try {
                            subscriptions.value = normalizeList(JSON.parse(savedSubs));
                        } catch {
                            subscriptions.value = [];
                        }
                    }
                    if (savedDebts) {
                        try {
                            debts.value = normalizeList(JSON.parse(savedDebts));
                        } catch {
                            debts.value = [];
                        }
                    }
                    if (savedLang) language.value = savedLang;
                    if (savedDisplayCurrency) displayCurrency.value = savedDisplayCurrency;
                    if (savedIncome) {
                        try {
                            const inc = JSON.parse(savedIncome);
                            income.value = {
                                amount: inc.amount || '',
                                currency: inc.currency || 'CNY'
                            };
                        } catch {}
                    }
                });

                watch(subscriptions, (newVal) => {
                    localStorage.setItem('my_finance_subs', JSON.stringify(newVal));
                }, { deep: true });

                watch(debts, (newVal) => {
                    localStorage.setItem('my_finance_debts', JSON.stringify(newVal));
                }, { deep: true });

                watch(language, (val) => {
                    localStorage.setItem('my_finance_lang', val);
                });

                watch(displayCurrency, (val) => {
                    localStorage.setItem('my_finance_display_currency', val);
                });

                watch(income, (val) => {
                    localStorage.setItem('my_finance_income', JSON.stringify(val));
                }, { deep: true });

                return {
                    currentTab,
                    language,
                    displayCurrency,
                    rates,
                    subscriptions,
                    debts,
                    newItem,
                    income,
                    currentList,
                    categoryTotals,
                    displayList,
                    addItem,
                    deleteItem,
                    calculateTotal,
                    calculateDebtPrincipalTotal,
                    convertToMonthly,
                    convertDebtTotal,
                    usdToDisplay,
                    currencySymbol,
                    t,
                    formatMoney,
                    exportText,
                    importText,
                    exportData,
                    importData,
                    totalMonthlyAll,
                    monthlyIncomeDisplay,
                    surplusDisplay,
                    stressRatioDisplay,
                    categoryOptions,
                    searchQuery,
                    sortKey
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
